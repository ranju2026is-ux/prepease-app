<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrepEase | Karnataka & SSC Mastery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { scroll-behavior: smooth; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a; 
            overflow-x: hidden; 
        }
        
        .hero-gradient {
            background: radial-gradient(circle at 100% 0%, rgba(67, 56, 202, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 0% 100%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            background-color: #ffffff;
        }

        .quote-bar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 70;
            background-color: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            color: white;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .quote-text {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            width: 100%;
            display: block;
        }

        .premium-card {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 2.5rem;
            padding: 2rem;
            transition: all 0.5s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px -2px rgba(15, 23, 42, 0.03);
        }

        .premium-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 30px -10px rgba(67, 56, 202, 0.12);
            border-color: rgba(67, 56, 202, 0.3);
        }

        /* ANKI CARD Challenge STYLES */
        .anki-card { perspective: 1000px; height: 500px; width: 100%; max-width: 500px; margin: 0 auto; }
        .anki-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .anki-card.flipped .anki-card-inner { transform: rotateY(180deg); }
        .anki-front, .anki-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 3.5rem;
            border-width: 2px;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .anki-front { border-color: #f1f5f9; background-color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .anki-back { border-color: #e0e7ff; background-color: #eef2ff; transform: rotateY(180deg); box-shadow: 0 10px 30px rgba(67, 56, 202, 0.1); }

        .font-kannada { line-height: 1.6; }
        .logo-box { animation: box-pulse 4s ease-in-out infinite; }
        @keyframes box-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .view-transition { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .break-word-custom { overflow-wrap: anywhere; word-break: break-word; hyphens: auto; }
    </style>
</head>
<body>

    <div class="quote-bar">
        <span id="floating-quote" class="quote-text">Stay Disciplined. Excellence is a daily habit. üéØ</span>
    </div>

    <nav class="fixed top-10 w-full z-50 bg-white/80 backdrop-blur-xl border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 group cursor-pointer" onclick="navigateTo('home')">
                <div class="relative flex items-center justify-center logo-box">
                    <svg width="36" height="36" viewBox="0 0 40 40" fill="none"><rect width="40" height="40" rx="10" fill="#4338ca"/><path d="M15 28V12H21.5C24.5376 12 27 14.4624 27 17.5C27 20.5376 24.5376 23 21.5 23H15" stroke="white" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <span class="text-xl font-black tracking-tighter uppercase">PrepEase</span>
            </div>
            <div id="auth-header-btn"></div>
        </div>
    </nav>

    <main id="app-shell" class="pt-[120px] min-h-screen">
        <!-- Views load here -->
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAh6pjj_eOmw2I6FMM63bDmwj5eIlbvZAI",
            authDomain: "prepease-app.firebaseapp.com",
            projectId: "prepease-app",
            storageBucket: "prepease-app.firebasestorage.app",
            messagingSenderId: "200948432412",
            appId: "1:200948432412:web:de0582b6437305c822a9d9",
            measurementId: "G-5673GJ545C"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'prepease-app';

        // --- STATE ---
        const state = {
            view: 'home',
            isAuthenticated: false,
            userName: '',
            userId: null,
            progress: {},
            mistakes: [],
            totalPoints: 0,
            totalCoins: 0,
            authMode: 'login',
            currentAnkiIndex: 0,
            isAnkiFlipped: false
        };
        window.state = state;

        const floatingQuotes = [
            "Believe in your potential. Excellence is a habit. üéØ",
            "Mistakes are lessons in disguise. üìö",
            "Aspirant to Officer: Keep moving. üèõÔ∏è",
            "Persistence beats resistance. ‚ö°",
            "Precision is the path to success. üíé",
            "Believe. Practice. Succeed. üèÜ"
        ];

        const topicsData = {
            grammar: [
                { id: 'nouns', title: 'Nouns & Case', icon: 'üî°' },
                { id: 'tenses', title: 'Tense Mastery', icon: '‚è≥' },
                { id: 'articles', title: 'Articles', icon: 'üÖ∞Ô∏è' }
            ],
            vocabulary: [
                { id: 'synonyms', title: 'Synonyms', icon: 'üìñ' },
                { id: 'antonyms', title: 'Antonyms', icon: 'üåì' },
                { id: 'idioms', title: 'Idioms & Phrases', icon: 'üé≠' }
            ]
        };

        // --- NAVIGATION & AUTH ---
        window.navigateTo = (view, params = {}) => {
            const protectedViews = ['english-selection', 'topics-grid', 'levels-grid', 'content-view', 'mistakes-book', 'doubts', 'exams-pyq'];
            if (protectedViews.includes(view) && !state.isAuthenticated) {
                state.view = 'login';
            } else {
                state.view = view;
            }
            Object.assign(state, params);
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.handleLogout = async () => { 
            await signOut(auth); 
            state.isAuthenticated = false; 
            state.userName = '';
            state.userId = null;
            navigateTo('login'); 
        };

        async function handleAuth(e) {
            e.preventDefault();
            const userIn = document.getElementById('username-input').value;
            const passIn = document.getElementById('password-input').value;
            const isSignUp = state.authMode === 'signup';
            const email = `${userIn.toLowerCase()}@prepease.internal`;
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = isSignUp ? "Creating Profile..." : "Authorizing...";

            try {
                if (isSignUp) {
                    const fullName = document.getElementById('name-input').value;
                    const res = await createUserWithEmailAndPassword(auth, email, passIn);
                    await setDoc(doc(db, 'artifacts', appId, 'users', res.user.uid, 'profile', 'info'), { 
                        name: fullName, username: userIn, joinedAt: new Date().toISOString() 
                    });
                    state.userName = fullName;
                } else {
                    await signInWithEmailAndPassword(auth, email, passIn);
                }
                navigateTo('home');
            } catch (err) { 
                alert(isSignUp ? "Signup Failed: Username ID might be taken." : "Access Denied: Check Username/Password."); 
                btn.disabled = false;
                btn.innerText = isSignUp ? "Create Account" : "Authorize";
            }
        }

        async function loadUserData() {
            if (!auth.currentUser) return;
            state.userId = auth.currentUser.uid;
            const profileSnap = await getDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'profile', 'info'));
            if (profileSnap.exists()) {
                state.userName = profileSnap.data().name;
                state.isAuthenticated = true;
                render();
            }
            onSnapshot(collection(db, 'artifacts', appId, 'users', state.userId, 'progress'), (snap) => {
                state.progress = {}; state.totalPoints = 0; state.totalCoins = 0;
                snap.forEach(doc => {
                    const d = doc.data();
                    state.progress[doc.id] = d;
                    state.totalPoints += (d.points || 0);
                    state.totalCoins += (d.coins || 0);
                });
                if (state.view === 'home') render();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'users', state.userId, 'mistakes'), (snap) => {
                state.mistakes = [];
                snap.forEach(doc => state.mistakes.push({ id: doc.id, ...doc.data() }));
                if (state.view === 'home' || state.view === 'mistakes-book') render();
            }, (err) => console.error("Mistakes Listener Error:", err));
        }

        // --- RENDER SYSTEM ---
        function render() {
            const shell = document.getElementById('app-shell');
            const authBtn = document.getElementById('auth-header-btn');

            if (state.isAuthenticated) {
                authBtn.innerHTML = `<button onclick="handleLogout()" class="text-[10px] font-black uppercase tracking-widest text-rose-500 px-4 py-2 hover:bg-rose-50 rounded-xl transition-all">Sign Out</button>`;
            } else {
                authBtn.innerHTML = `<button onclick="navigateTo('login')" class="text-[10px] font-black uppercase tracking-widest text-indigo-600 px-4 py-2 hover:bg-indigo-50 rounded-xl transition-all">Join Now</button>`;
            }

            if (!state.isAuthenticated && state.view !== 'login') {
                state.view = 'login';
            }

            switch(state.view) {
                case 'home': shell.innerHTML = renderHome(); break;
                case 'login': shell.innerHTML = renderLogin(); break;
                case 'mistakes-book': shell.innerHTML = renderMistakesBook(); break;
                case 'doubts': shell.innerHTML = renderDoubts(); break;
                case 'english-selection': shell.innerHTML = renderEnglishSelection(); break;
                case 'topics-grid': shell.innerHTML = renderTopicsGrid(); break;
                case 'levels-grid': shell.innerHTML = renderLevelsGrid(); break;
                case 'exams-pyq': shell.innerHTML = renderExamsPYQ(); break;
                case 'content-view': shell.innerHTML = `<div id="content-container" class="max-w-6xl mx-auto px-6 py-20"></div>`; loadContent(); break;
            }
        }
        window.render = render;

        // --- MISTAKES BOOK LOGIC ---
        function renderMistakesBook() {
            if (state.mistakes.length === 0) {
                return `
                <div class="max-w-xl mx-auto py-40 text-center view-transition">
                    <div class="text-6xl mb-6">üíé</div>
                    <h3 class="font-black text-2xl text-slate-900 mb-2 uppercase tracking-tight">Zero Errors Found</h3>
                    <p class="text-slate-400 uppercase text-[10px] tracking-widest mb-10">Your accuracy is impeccable. Keep practicing!</p>
                    <button onclick="navigateTo('home')" class="px-12 py-5 bg-indigo-600 text-white font-black rounded-3xl shadow-xl uppercase text-xs">Return Dashboard</button>
                </div>`;
            }

            const current = state.mistakes[state.currentAnkiIndex];
            const flippedClass = state.isAnkiFlipped ? 'flipped' : '';
            const options = current.options || [];

            return `
            <div class="max-w-3xl mx-auto py-20 px-6 view-transition">
                <div class="flex justify-between items-center mb-10">
                    <h2 class="text-xl font-black text-slate-900 uppercase tracking-widest">Mastery Deck</h2>
                    <span class="text-[10px] font-black bg-slate-900 text-white px-4 py-1.5 rounded-full">${state.currentAnkiIndex + 1} / ${state.mistakes.length}</span>
                </div>

                <div class="anki-card ${flippedClass}">
                    <div class="anki-card-inner">
                        <!-- FRONT -->
                        <div class="anki-front">
                            <span class="px-4 py-1.5 bg-rose-50 text-rose-600 rounded-full text-[9px] font-black uppercase mb-8 border border-rose-100">Recall Case</span>
                            <h3 class="text-xl font-bold text-slate-900 leading-relaxed mb-10 italic break-word-custom">"${current.question}"</h3>
                            <div class="grid grid-cols-1 gap-3 w-full">
                                ${options.map(o => `
                                    <button onclick="resolveAnki('${o.trim()}', '${current.answer.trim()}')" 
                                            class="w-full py-4 px-6 border-2 border-slate-50 bg-slate-50/50 rounded-[2rem] text-sm font-bold text-slate-600 hover:border-indigo-600 hover:bg-white transition-all text-left break-word-custom">
                                        ${o}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <!-- BACK -->
                        <div class="anki-back">
                            <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-6">Mentor Analysis</p>
                            <div class="bg-white/60 p-8 rounded-[2.5rem] mb-6 w-full border border-indigo-100">
                                <p class="text-[10px] font-black text-emerald-600 uppercase mb-2">Target Answer</p>
                                <p class="text-xl font-bold text-slate-900 leading-tight break-word-custom">${current.answer}</p>
                            </div>
                            <p class="text-sm text-indigo-900 font-medium leading-relaxed italic break-word-custom">"${current.explanation || 'Master this logic to build precision.'}"</p>
                            <button onclick="nextAnki()" class="mt-10 px-12 py-5 bg-indigo-600 text-white font-black rounded-3xl text-[10px] uppercase shadow-lg shadow-indigo-200">Next Case ‚ûú</button>
                            <p class="mt-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">Mastery Progress: ${current.masteryCount || 0} / 5</p>
                        </div>
                    </div>
                </div>
                <div class="mt-12 text-center">
                    <button onclick="navigateTo('home')" class="text-slate-400 font-black text-[10px] uppercase tracking-widest hover:text-slate-900 transition-all">Close Deck</button>
                </div>
            </div>`;
        }

        window.resolveAnki = async (selected, correct) => {
            if (!state.userId) return;
            const current = state.mistakes[state.currentAnkiIndex];
            const mistakeRef = doc(db, 'artifacts', appId, 'users', state.userId, 'mistakes', current.id);
            
            if (selected === correct) {
                const newCount = (current.masteryCount || 0) + 1;
                if (newCount >= 5) {
                    await deleteDoc(mistakeRef);
                } else {
                    await updateDoc(mistakeRef, { masteryCount: newCount });
                }
            } else {
                // Wrong answer resets the mastery count
                await updateDoc(mistakeRef, { masteryCount: 0 });
            }
            
            state.isAnkiFlipped = true;
            render();
        };

        window.nextAnki = () => {
            state.isAnkiFlipped = false;
            state.currentAnkiIndex = (state.currentAnkiIndex + 1) % (state.mistakes.length || 1);
            render();
        };

        // --- ASSESSMENT ENGINE ---
        window.loadQuiz = async () => {
            const container = document.getElementById('content-container');
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            container.innerHTML = `<div class="py-20 text-center animate-pulse text-indigo-400 font-bold uppercase text-xs">Loading Assessment Module...</div>`;
            
            const paths = [
                `content/general-english/${type}/${topic}/level-${level}-test.json`,
                `content/general-english/${type}/${topic}/level${level}-test.json`
            ];
            
            let questions = null;
            let finalAttemptedUrl = "";

            for (const path of paths) {
                const url = new URL(path, window.location.href).href;
                finalAttemptedUrl = url;
                try {
                    const res = await fetch(url);
                    if (res.ok) {
                        questions = await res.json();
                        break; 
                    }
                } catch (e) { console.warn(`Path failed: ${url}`); }
            }

            if (questions) {
                renderQuiz(questions);
            } else {
                container.innerHTML = `
                    <div class="text-center p-20 bg-white rounded-[3rem] border-2 border-rose-100 view-transition">
                        <div class="text-5xl mb-6">‚ùå</div>
                        <h3 class="font-bold text-xl mb-4 text-slate-900">Assessment Unavailable</h3>
                        <p class="text-slate-500 text-sm mb-8">Could not find the test file for Level ${level}.</p>
                        <button onclick="state.view = 'content-view'; render();" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-2xl uppercase text-[10px]">Back to Lesson</button>
                    </div>
                `;
            }
        };

        function renderQuiz(questions) {
            const container = document.getElementById('content-container');
            container.innerHTML = `<h2 class="text-3xl font-black mb-10">Assessment Phase</h2><div id="quiz-list" class="space-y-6"></div>`;
            const list = document.getElementById('quiz-list');
            questions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = "bg-white p-10 rounded-[3.5rem] border-2 border-slate-100 shadow-sm";
                div.innerHTML = `<p class="text-lg font-bold mb-8">#${i+1} ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${q.options.map(o => `<label class="flex items-center gap-4 px-8 py-5 border-2 border-slate-50 rounded-[2rem] cursor-pointer hover:bg-slate-50 has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50 transition-all"><input type="radio" name="q${i}" value="${o.trim()}" class="accent-indigo-600 w-5 h-5"><span>${o}</span></label>`).join('')}</div>`;
                list.appendChild(div);
            });
            const btn = document.createElement('button');
            btn.className = "w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-xl uppercase mt-8";
            btn.innerText = "Synchronize Results";
            btn.onclick = () => submitTest(questions);
            list.appendChild(btn);
        }

        window.submitTest = async function(questions) {
            let score = 0, wrong = 0, mistakesFound = [], resultHTML = "";
            questions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                const isCorrect = sel && sel.value.trim() === q.answer.trim();
                if (isCorrect) score++; 
                else {
                    wrong++;
                    mistakesFound.push({ question: q.question, answer: q.answer, options: q.options, explanation: q.explanation, userAnswer: sel ? sel.value : 'No selection' });
                }
                const bgColor = isCorrect ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100';
                resultHTML += `<div class="${bgColor} p-8 rounded-[2.5rem] mb-6 border transition-all font-bold"><div class="flex items-center justify-between mb-4"><span class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-xs font-bold text-slate-400">#${i + 1}</span><p class="text-[10px] font-black uppercase ${isCorrect ? 'text-emerald-600' : 'text-rose-500'}">${isCorrect ? 'Correct' : 'Incorrect'}</p></div><p class="text-slate-800 font-bold mb-4">${q.question}</p><div class="grid grid-cols-2 gap-4"><div class="bg-white/60 p-4 rounded-xl"><p class="text-[8px] font-black opacity-60 uppercase mb-1">Your Choice</p><p class="text-sm font-bold">${sel ? sel.value : 'None'}</p></div><div class="bg-emerald-500/10 p-4 rounded-xl"><p class="text-[8px] font-black text-emerald-600 uppercase mb-1">Correct Answer</p><p class="text-sm font-bold text-emerald-700 font-bold font-bold font-bold">${q.answer}</p></div></div><p class="mt-4 text-xs italic text-slate-500 font-bold">${q.explanation || ''}</p></div>`;
            });
            const points = score * 10 + (score === questions.length ? 50 : 0);
            const coins = score - Math.floor(wrong/4);
            await saveResultToCloud(score, questions.length, points, coins, mistakesFound);
            renderResultsView(score, questions.length, points, coins, resultHTML);
        };

        async function saveResultToCloud(score, total, points, coins, mistakes) {
            if (!auth.currentUser) return;
            const progressId = `${state.currentType}_${state.currentTopic}_${state.currentLevel}`;
            await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'progress', progressId), { score, total, points, coins, completedAt: new Date().toISOString(), type: state.currentType, topic: state.currentTopic, level: state.currentLevel });
            
            for (const m of mistakes) {
                // Unique mistake ID based on the question text
                const mId = btoa(m.question).substring(0, 20);
                await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'mistakes', mId), { 
                    ...m, 
                    masteryCount: 0, 
                    lastFailed: new Date().toISOString() 
                }, { merge: true });
            }
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', state.userId), { name: state.userName, points: (state.totalPoints || 0) + points }, { merge: true });
        }

        function renderResultsView(score, total, pts, coins, html) {
            const container = document.getElementById('content-container');
            container.innerHTML = `<div class="view-transition"><div class="bg-white border-2 border-slate-100 p-16 rounded-[4rem] shadow-sm text-center mb-10 relative overflow-hidden"><div class="flex justify-center gap-10 mb-10"><div class="text-center font-bold font-bold font-bold"><p class="text-4xl font-black text-emerald-600">ü™ô +${score}</p><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest font-bold font-bold">Coins</p></div><div class="w-px h-12 bg-slate-100 self-center"></div><div class="text-center font-bold font-bold font-bold"><p class="text-4xl font-black text-indigo-600 font-bold">PTS ${pts}</p><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest font-bold font-bold font-bold">Points</p></div></div><h2 class="text-5xl font-black text-slate-900 mb-4 tracking-tighter">Level Analysis</h2><div class="flex justify-center items-baseline gap-2 mb-12"><span class="text-[6rem] font-black text-indigo-600 leading-none font-bold font-bold">${score}</span><span class="text-3xl font-bold text-slate-300">/ ${total}</span></div><div class="flex flex-col sm:flex-row gap-6 justify-center"><button onclick="navigateTo('home')" class="px-12 py-5 bg-slate-900 text-white font-black rounded-2xl hover:bg-slate-800 transition-all uppercase tracking-widest text-[10px] font-bold font-bold">Return Dashboard</button></div></div><h3 class="text-2xl font-black text-slate-900 mb-10 px-4 uppercase tracking-[0.1em] font-bold font-bold">Mastery Review Log</h3>${html}</div>`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- CONTENT LOADER ---
        window.loadContent = async () => {
            const container = document.getElementById('content-container');
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const url = new URL(`content/general-english/${type}/${topic}/level-${level}.json`, window.location.href).href;
            container.innerHTML = `<div class="py-20 text-center animate-pulse text-slate-400 font-black uppercase text-xs">Opening Lesson...</div>`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                renderCards(data);
            } catch (e) {
                container.innerHTML = `<div class="text-center p-20 bg-white rounded-[3rem] border-2 border-slate-100"><div class="text-5xl mb-6">üìÅ</div><h3 class="font-bold text-xl mb-4">Phase Offline</h3><p class="text-slate-400 text-sm mb-8">Lesson data not found.</p><button onclick="navigateTo('levels-grid')" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-2xl uppercase text-[10px]">Back to grid</button></div>`;
            }
        };

        function renderCards(data) {
            const container = document.getElementById('content-container');
            container.innerHTML = `<div class="mb-12 text-center lg:text-left"><h2 class="text-4xl font-black text-slate-900 tracking-tighter">Phase ${state.currentLevel} <span class="text-indigo-600 font-bold">Case Cards</span></h2></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 font-bold font-bold">${data.map(item => `<div class="bg-white p-10 rounded-[3.5rem] border-2 border-slate-50 hover:border-indigo-100 transition-all text-center group shadow-sm flex flex-col items-center overflow-hidden"><div class="text-5xl mb-8 group-hover:scale-110 transition-transform font-bold">${item.emoji || 'üìó'}</div><h3 class="text-3xl font-black text-slate-900 tracking-tighter mb-8 break-word-custom w-full font-bold">${item.word}</h3><div class="pt-6 border-t border-slate-50 w-full"><p class="text-2xl font-bold text-slate-800 font-kannada leading-tight break-word-custom font-bold">${item.meaning_kannada}</p><p class="text-sm text-slate-400 mt-3 font-medium leading-relaxed italic break-word-custom font-bold">${item.meaning_english}</p></div></div>`).join('')}<div class="col-span-full mt-10"><button onclick="loadQuiz()" class="w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-2xl uppercase text-xs tracking-widest active:scale-95 transition-all font-bold">Launch Assessment</button></div></div>`;
        }

        // --- OTHER VIEWS ---
        window.handleLevelSelection = (lv, progressId) => { 
            const isDone = state.progress[progressId]; 
            if (isDone) { 
                const shell = document.getElementById('app-shell'); 
                shell.innerHTML = `<div class="max-w-xl mx-auto py-32 px-6 text-center view-transition font-bold"><div class="bg-white border-2 border-emerald-100 p-12 rounded-[3.5rem] shadow-xl"><span class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-3xl mb-8 mx-auto font-bold font-bold">üèÜ</span><h2 class="text-3xl font-black text-slate-900 mb-2 font-bold font-bold">Phase ${lv} Complete</h2><p class="text-slate-400 font-bold uppercase tracking-widest text-[10px] mb-8 font-bold font-bold">Performance: ${isDone.score}/${isDone.total}</p><div class="space-y-4"><button onclick="navigateTo('content-view', { currentLevel: ${lv} })" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl uppercase tracking-widest text-xs font-bold font-bold">Review Lessons</button><button onclick="state.currentLevel = ${lv}; state.view = 'content-view'; render(); loadQuiz();" class="w-full py-5 border-2 border-slate-100 text-slate-600 font-black rounded-2xl hover:bg-slate-50 transition-all uppercase tracking-widest text-xs font-bold font-bold">Reattempt Quiz</button><button onclick="navigateTo('levels-grid')" class="w-full py-2 text-slate-300 font-bold uppercase tracking-widest text-[10px] mt-4 font-bold font-bold font-bold">Close Hub</button></div></div></div>`; 
            } else { 
                navigateTo('content-view', { currentLevel: lv }); 
            } 
        };

        function renderLogin() {
            const isLogin = state.authMode === 'login';
            return `<div class="max-w-md mx-auto py-32 px-6 view-transition text-center font-bold"><h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-10 font-bold font-bold">${isLogin ? 'Mission Login' : 'Enroll Academy'}</h2><form id="auth-form" class="bg-white border border-slate-200 p-10 rounded-[3rem] shadow-sm text-left font-bold">${!isLogin ? `<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-bold font-bold">Full Name</label><input id="name-input" type="text" placeholder="e.g. Rahul Kumar" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-6 outline-none focus:border-indigo-600 transition-all" required>` : ''}<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-bold">Username ID</label><input id="username-input" type="text" placeholder="ID" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-6 outline-none focus:border-indigo-600 transition-all" required><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-bold font-bold">Password</label><input id="password-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-10 outline-none focus:border-indigo-600 transition-all font-bold" required><button type="submit" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl uppercase text-xs font-bold">Authorize</button><button type="button" onclick="state.authMode = '${isLogin ? 'signup' : 'login'}'; render();" class="mt-8 w-full text-indigo-600 font-bold text-xs hover:underline font-bold">${isLogin ? "New Aspirant? Create ID" : "Login Now"}</button></form></div>`;
        }

        function renderHome() {
            const rank = (p) => p < 500 ? 'üå± Junior' : p < 2000 ? '‚öîÔ∏è Warrior' : 'üèõÔ∏è Officer';
            return `<div class="hero-gradient p-10 view-transition font-bold"><div class="max-w-7xl mx-auto"><div class="mb-12"><h2 class="text-6xl font-black text-slate-900 tracking-tighter mb-4 leading-tight font-bold font-bold">Hello, <span class="text-indigo-600 font-bold">${state.userName || 'Aspirant'}!</span></h2></div><div class="mb-12 font-bold font-bold"><div class="bg-indigo-600 p-12 rounded-[3.5rem] text-white shadow-2xl shadow-indigo-200 flex flex-col md:flex-row justify-between items-center gap-8"><div class="text-center md:text-left font-bold"><p class="text-[10px] font-black uppercase tracking-widest opacity-60 mb-2 font-bold font-bold">Total Progress</p><p class="text-7xl font-black leading-none font-bold">${state.totalPoints || 0}</p><p class="text-sm font-bold opacity-80 mt-2 uppercase tracking-tighter font-bold">Mastery Points</p></div><div class="flex gap-6 font-bold font-bold"><div class="bg-white/10 p-6 rounded-3xl text-center border border-white/5 font-bold font-bold font-bold"><p class="text-2xl font-black font-bold">ü™ô ${state.totalCoins || 0}</p><p class="text-[9px] font-black uppercase opacity-60 mt-1 font-bold font-bold">Coins</p></div><div class="bg-white/10 p-6 rounded-3xl text-center border border-white/5 font-bold font-bold font-bold"><p class="text-2xl font-black font-bold font-bold">${rank(state.totalPoints)}</p><p class="text-[9px] font-black uppercase opacity-60 mt-1 font-bold font-bold font-bold">Status</p></div></div></div></div><div class="mb-16 font-bold font-bold"><h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-8 font-bold">Curriculum Units</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6 font-bold font-bold"><div onclick="navigateTo('english-selection')" class="premium-card group font-bold font-bold font-bold"><div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-all font-bold font-bold">üá¨üáß</div><h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">General English</h3><p class="text-slate-500 text-xs font-bold font-bold">Levels 1-10 complete roadmap.</p></div><div onclick="navigateTo('exams-pyq', { currentCategory: 'karnataka' })" class="premium-card group font-bold font-bold font-bold"><div class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-emerald-600 group-hover:text-white transition-all font-bold font-bold font-bold">üèõÔ∏è</div><h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">KPSC Hub</h3><p class="text-slate-500 text-xs font-bold font-bold font-bold">Regional blueprints.</p></div><div onclick="navigateTo('exams-pyq', { currentCategory: 'ssc' })" class="premium-card group font-bold font-bold font-bold font-bold"><div class="w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-amber-600 group-hover:text-white transition-all font-bold font-bold font-bold font-bold">‚öîÔ∏è</div><h3 class="text-xl font-bold text-slate-900 mb-2 font-bold font-bold">SSC Central</h3><p class="text-slate-500 text-xs font-bold font-bold font-bold font-bold">CGL, CHSL focus bank.</p></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12 font-bold font-bold"><div onclick="navigateTo('mistakes-book')" class="bg-white border-2 border-rose-100 p-10 rounded-[3.5rem] shadow-sm hover:shadow-xl transition-all cursor-pointer group flex items-center justify-between font-bold font-bold"><div class="font-bold"><p class="text-[10px] font-black uppercase tracking-widest text-rose-400 mb-1 font-bold">Retention Lab</p><h3 class="text-2xl font-bold text-slate-900 font-bold font-bold">Mistakes Book</h3><p class="text-slate-500 text-xs mt-2 font-bold font-bold font-bold">${state.mistakes.length} errors to master.</p></div><div class="w-16 h-16 bg-rose-50 text-rose-600 rounded-3xl flex items-center justify-center text-3xl group-hover:bg-rose-600 group-hover:text-white transition-all font-bold font-bold">üìì</div></div><div onclick="navigateTo('doubts')" class="bg-white border-2 border-emerald-100 p-10 rounded-[3.5rem] shadow-sm hover:shadow-xl transition-all cursor-pointer group flex items-center justify-between font-bold font-bold font-bold"><div class="font-bold font-bold"><p class="text-[10px] font-black uppercase tracking-widest text-emerald-500 mb-1 font-bold">Private Support</p><h3 class="text-2xl font-bold text-slate-900 font-bold">Support Hub</h3><p class="text-slate-500 text-xs mt-2 font-bold">Direct sync with mentors.</p></div><div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-3xl flex items-center justify-center text-3xl group-hover:bg-emerald-600 group-hover:text-white transition-all font-bold font-bold font-bold">üí¨</div></div></div><div class="pt-10 border-t border-slate-100 flex justify-between items-center text-center font-bold font-bold font-bold"><p class="text-slate-400 text-[10px] font-black uppercase tracking-widest font-bold">¬© 2026 PrepEase Hub</p><a href="https://t.me/prepeaseengl" target="_blank" class="text-indigo-600 font-bold text-xs font-bold font-bold">üì¢ Telegram Hub</a></div></div></div>`;
        }

        function renderEnglishSelection() { return `<div class="max-w-7xl mx-auto px-6 py-20 text-center view-transition font-bold"><button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 uppercase text-xs tracking-widest font-bold font-bold font-bold font-bold">‚Üê Dashboard</button><h2 class="text-4xl font-black mb-12 font-bold font-bold">English <span class="text-indigo-600 font-bold font-bold font-bold">Track</span></h2><div class="grid grid-cols-1 md:grid-cols-2 gap-10 text-left font-bold font-bold"><div onclick="navigateTo('topics-grid', { currentType: 'grammar' })" class="premium-card group font-bold font-bold font-bold"><span>Rule Foundations</span><h3 class="text-3xl font-black mb-4 font-bold font-bold font-bold font-bold">English Grammar</h3><p class="mb-8 font-bold font-bold font-bold font-bold">Master Foundations.</p><span class="font-bold">Open Unit ‚ûú</span></div><div onclick="navigateTo('topics-grid', { currentType: 'vocabulary' })" class="premium-card group font-bold font-bold font-bold font-bold"><span>Recall Case</span><h3 class="text-3xl font-black mb-4 font-bold font-bold font-bold font-bold">Vocabulary Hub</h3><p class="mb-8 font-bold font-bold font-bold">Recall mappings.</p><span class="font-bold font-bold font-bold">Open Unit ‚ûú</span></div></div></div>`; }
        function renderTopicsGrid() { const topics = topicsData[state.currentType] || []; return `<div class="max-w-7xl mx-auto px-6 py-20 text-center view-transition font-bold"><button onclick="navigateTo('english-selection')" class="text-slate-400 font-bold mb-8 uppercase text-xs font-bold font-bold font-bold">‚Üê Back</button><h2 class="text-4xl font-black capitalize mb-12 font-bold font-bold font-bold">${state.currentType} Mastery</h2><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 text-left font-bold font-bold font-bold">${topics.map(t => `<div onclick="navigateTo('levels-grid', { currentTopic: '${t.id}', currentTopicTitle: '${t.title}' })" class="premium-card p-10 group font-bold font-bold"><div class="text-5xl mb-8 font-bold">${t.icon}</div><h3 class="text-xl font-bold mb-4 font-bold">${t.title}</h3><p class="text-[9px] opacity-60 uppercase font-bold font-bold">Integrated Phase</p></div>`).join('')}</div></div>`; }
        function renderLevelsGrid() { return `<div class="max-w-7xl mx-auto px-6 py-20 text-center view-transition font-bold font-bold font-bold"><button onclick="navigateTo('topics-grid')" class="text-slate-400 font-bold mb-8 uppercase text-xs font-bold font-bold font-bold">‚Üê Back</button><h2 class="text-4xl font-black mb-16 font-bold font-bold font-bold">${state.currentTopicTitle} Phases</h2><div class="grid grid-cols-2 md:grid-cols-5 gap-6 font-bold font-bold font-bold">${Array.from({length: 10}, (_, i) => i + 1).map(lv => { const progressId = `${state.currentType}_${state.currentTopic}_${lv}`; const isDone = state.progress[progressId]; return `<div onclick="handleLevelSelection(${lv}, '${progressId}')" class="p-10 border-2 ${isDone ? 'border-emerald-500 bg-emerald-50/30' : 'border-slate-100 bg-white'} rounded-[3rem] text-center hover:border-indigo-600 transition-all cursor-pointer relative font-bold font-bold font-bold">${isDone ? `<span class="absolute top-4 right-4 text-emerald-600 text-[8px] bg-emerald-100 px-2 rounded-full uppercase border border-emerald-200">DONE</span>` : ''}<span class="text-4xl font-bold font-bold font-bold">${lv}</span></div>`; }).join('')}</div></div>`; }
        function renderExamsPYQ() { return `<div class="max-w-7xl mx-auto px-6 py-20 text-center font-bold font-bold font-bold font-bold"><button onclick="navigateTo('home')" class="text-slate-400 mb-8 uppercase text-xs font-bold font-bold">‚Üê Dashboard</button><h2 class="text-4xl font-black mb-12 capitalize font-bold font-bold font-bold">${state.currentCategory} Regional Hub</h2><div class="bg-white border border-slate-100 p-20 rounded-[4rem] text-center shadow-sm font-bold font-bold font-bold">üìÇ Coming soon.</div></div>`; }
        function renderDoubts() { return `<div class="max-w-4xl mx-auto py-24 px-6 text-center view-transition font-bold font-bold font-bold"><div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-[2.5rem] flex items-center justify-center text-4xl mx-auto mb-10 shadow-lg shadow-emerald-100 font-bold font-bold">üí¨</div><h2 class="text-4xl font-black text-slate-900 mb-4 font-bold font-bold">Private Logic Sync</h2><p class="text-slate-500 mb-16 italic font-bold font-bold font-bold">Submit doubt for WhatsApp Sync.</p><div class="bg-white border border-slate-100 p-10 rounded-[4rem] shadow-sm max-w-2xl mx-auto text-left relative overflow-hidden font-bold font-bold"><textarea id="query-text" placeholder="Explain rule doubt..." class="w-full h-40 bg-slate-50 border-2 border-slate-50 p-8 rounded-[2rem] font-medium mb-8 resize-none outline-none focus:bg-white transition-all font-bold font-bold font-bold"></textarea><button onclick="askDoubtOnWA()" class="w-full py-6 bg-emerald-600 text-white font-black rounded-3xl shadow-xl uppercase tracking-widest text-[11px] hover:bg-emerald-700 transition-all font-bold font-bold font-bold">Sync via WhatsApp</button></div><button onclick="navigateTo('home')" class="mt-20 py-5 px-10 bg-slate-900 text-white font-black rounded-[2rem] uppercase tracking-widest text-[10px] font-bold font-bold font-bold">Return Dashboard</button></div>`; }

        window.askDoubtOnWA = function() {
            const input = document.getElementById('query-text');
            const userMsg = input.value.trim();
            const text = encodeURIComponent(`PrepEase Inquiry\nFrom: ${state.userName}\n\nDoubt: ${userMsg || "General Doubt"}`);
            window.open(`https://wa.me/918088165696?text=${text}`, '_blank');
            input.value = '';
        };

        function getBaseDir() {
            const path = window.location.pathname;
            return path.substring(0, path.lastIndexOf('/') + 1) || '/';
        }

        // Init App
        onAuthStateChanged(auth, (user) => { 
            if (user) {
                loadUserData(); 
            } else { 
                state.isAuthenticated = false; 
                render(); 
            } 
        });

        document.addEventListener('DOMContentLoaded', () => { 
            render(); 
            document.addEventListener('submit', (e) => { 
                if (e.target.id === 'auth-form') handleAuth(e); 
            }); 
        });

        // Floating Quote Rotation
        let fqi = 0;
        setInterval(() => {
            const el = document.getElementById('floating-quote');
            if (!el) return;
            el.style.opacity = '0';
            setTimeout(() => {
                fqi = (fqi + 1) % floatingQuotes.length;
                el.innerText = floatingQuotes[fqi];
                el.style.opacity = '1';
            }, 500);
        }, 6000);
    </script>
</body>
</html>
