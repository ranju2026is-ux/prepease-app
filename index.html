<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrepEase | Karnataka & SSC Mastery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { scroll-behavior: smooth; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a; 
            overflow-x: hidden; 
        }
        
        .hero-gradient {
            background: radial-gradient(circle at 100% 0%, rgba(67, 56, 202, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 0% 100%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            background-color: #ffffff;
        }

        .premium-card {
            @apply bg-white border border-slate-200 rounded-[2.5rem] p-8 transition-all duration-500 cursor-pointer;
            box-shadow: 0 4px 12px -2px rgba(15, 23, 42, 0.03);
        }

        .premium-card:hover {
            @apply -translate-y-2;
            box-shadow: 0 20px 30px -10px rgba(67, 56, 202, 0.12);
            border-color: rgba(67, 56, 202, 0.3);
        }

        /* CARD STYLE CONTENT */
        .flashcard-container {
            @apply w-full max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6;
        }
        
        .flashcard {
            @apply bg-white border-2 border-slate-100 rounded-[2.5rem] p-6 transition-all duration-300 shadow-sm relative overflow-hidden flex flex-col items-center text-center;
            min-height: 380px;
        }

        .flashcard-answer {
            max-height: 0;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .flashcard.revealed {
            @apply border-indigo-300 bg-white;
            box-shadow: 0 15px 40px -10px rgba(67, 56, 202, 0.1);
        }

        .flashcard.revealed .flashcard-answer {
            max-height: 500px;
            opacity: 1;
            @apply mt-4 pt-4 border-t border-slate-50 w-full;
        }

        .reveal-btn {
            @apply mt-6 px-6 py-3 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-95 text-[10px] uppercase tracking-widest;
        }

        .flashcard.revealed .reveal-btn {
            @apply opacity-0 pointer-events-none absolute -bottom-20;
        }

        /* GRAPH BAR ANIMATION */
        .graph-bar {
            transition: height 1s ease-out;
        }

        /* LOGO ANIMATION - P in BOX */
        @keyframes box-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .logo-box { animation: box-pulse 4s ease-in-out infinite; }

        /* VIEW TRANSITIONS */
        .view-transition { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .fade-out { opacity: 0; transform: translateY(-10px); transition: all 0.5s ease; }
        .fade-in { opacity: 1; transform: translateY(0); transition: all 0.5s ease; }

        .font-kannada { line-height: 1.6; }
        input:focus { outline: none; border-color: #4338ca; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* RANK BADGE STYLES */
        .rank-badge {
            @apply px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest border flex items-center gap-1;
        }
    </style>
</head>
<body>

    <!-- TOP MOTIVATIONAL BAR -->
    <div id="moto-bar" class="fixed top-0 w-full z-[60] bg-slate-900 text-white py-2.5 overflow-hidden border-b border-white/10 shadow-xl">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <span id="moto-text" class="text-[10px] md:text-xs font-bold uppercase tracking-[0.25em] inline-block transition-all">
                Consistency is the key to Selection. üéØ
            </span>
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav class="fixed top-[44px] w-full z-50 bg-white/80 backdrop-blur-xl border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 group cursor-pointer" id="nav-logo">
                <div class="relative flex items-center justify-center logo-box">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="40" height="40" rx="10" fill="#4338ca"/>
                        <path d="M15 28V12H21.5C24.5376 12 27 14.4624 27 17.5C27 20.5376 24.5376 23 21.5 23H15" stroke="white" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="flex flex-col leading-none text-left">
                    <span class="text-xl font-black tracking-tighter text-slate-900 group-hover:text-indigo-600 transition-colors uppercase">PrepEase</span>
                    <span class="text-[9px] font-bold text-emerald-600 uppercase tracking-[0.2em]">Mastery Academy</span>
                </div>
            </div>
            
            <div id="nav-links" class="hidden md:flex items-center gap-8">
                <button id="btn-home" class="text-sm font-semibold text-slate-600 hover:text-indigo-700 transition-colors">Dashboard</button>
                <button id="btn-mistakes" class="text-sm font-semibold text-slate-600 hover:text-indigo-700 transition-colors">Mistakes Book</button>
                <button id="btn-doubts" class="text-sm font-semibold text-slate-600 hover:text-indigo-700 transition-colors">Support</button>
                <div class="h-4 w-px bg-slate-200"></div>
                <div id="auth-status"></div>
            </div>
        </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main id="app-shell" class="pt-[124px] min-h-screen">
        <!-- Views -->
    </main>

    <!-- FOOTER -->
    <footer class="py-16 bg-white border-t border-slate-100">
        <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-8 text-center md:text-left">
            <div>
                <span class="text-lg font-black tracking-tighter text-slate-900 uppercase font-bold">PrepEase Mastery</span>
                <p class="text-slate-400 text-xs mt-2 max-w-xs leading-relaxed">Personalized study roadmap for KPSC & SSC aspirants. Your journey to selection starts here.</p>
            </div>
            <div class="flex flex-col md:flex-row gap-8 items-center">
                <a href="https://t.me/prepeaseengl" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-bold text-[10px] uppercase tracking-widest transition-colors flex items-center gap-2">
                    <span class="p-1 bg-indigo-50 rounded-lg">üì¢</span> Join Telegram
                </a>
                <button onclick="navigateTo('doubts')" class="text-emerald-600 hover:text-emerald-800 font-bold text-[10px] uppercase tracking-widest transition-colors flex items-center gap-2">
                    <span class="p-1 bg-emerald-50 rounded-lg">üí¨</span> Ask a Doubt
                </button>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAh6pjj_eOmw2I6FMM63bDmwj5eIlbvZAI",
            authDomain: "prepease-app.firebaseapp.com",
            projectId: "prepease-app",
            storageBucket: "prepease-app.firebasestorage.app",
            messagingSenderId: "200948432412",
            appId: "1:200948432412:web:de0582b6437305c822a9d9",
            measurementId: "G-5673GJ545C"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'prepease-app';

        // --- DATA & STATE ---
        const quotes = [
            "Consistency is the key to Selection. üéØ",
            "Mastering English is half the battle won. üá¨üáß",
            "KPSC Excellence begins with everyday habits. üèõÔ∏è",
            "Hard work today, Officer rank tomorrow. üáÆüá≥",
            "Focus on the mission, not the competition. ‚öîÔ∏è"
        ];

        const testMotivationalQuotes = [
            "Mistakes are proof that you are trying. Let's crush this test!",
            "Knowledge is power. Testing that knowledge is mastery.",
            "Believe you can and you're halfway there. Start the quiz!",
            "Your future self will thank you for this practice session.",
            "One step closer to your dream rank. Prove your learning!"
        ];
        
        const topicsData = {
            grammar: [
                { id: 'nouns', title: 'Nouns & Case', icon: 'üî°' },
                { id: 'tenses', title: 'Tense Mastery', icon: '‚è≥' },
                { id: 'articles', title: 'Articles', icon: 'üÖ∞Ô∏è' },
                { id: 'prepositions', title: 'Prepositions', icon: 'üìç' },
                { id: 'subject-verb', title: 'Subject-Verb Agreement', icon: '‚öñÔ∏è' }
            ],
            vocabulary: [
                { id: 'synonyms', title: 'Synonyms', icon: 'üìñ' },
                { id: 'antonyms', title: 'Antonyms', icon: 'üåì' },
                { id: 'substitution', title: 'One Word Substitution', icon: '1Ô∏è‚É£' },
                { id: 'idioms', title: 'Idioms & Phrases', icon: 'üé≠' }
            ]
        };

        const state = {
            view: 'home',
            isAuthenticated: false,
            userName: '',
            userId: null,
            intendedView: null,
            intendedParams: {},
            currentType: null,
            currentTopic: null,
            currentLevel: null,
            currentTopicTitle: '',
            progress: {},
            leaderboard: [],
            mistakes: [],
            authMode: 'login',
            totalPoints: 0,
            totalCoins: 0
        };

        // --- SPA ROUTING & HELPERS ---
        const getBaseDir = () => {
            const path = window.location.pathname;
            const base = path.substring(0, path.lastIndexOf('/') + 1) || '/';
            return base;
        };

        const getDynamicPath = (type, topic, level, isTest = false) => {
            const base = getBaseDir();
            const fileName = isTest ? `level${level}-test.json` : `level-${level}.json`;
            const relPath = `content/general-english/${type.toLowerCase()}/${topic.toLowerCase()}/${fileName}`;
            const finalURL = new URL(relPath, window.location.origin + base).href;
            return finalURL;
        };

        const updateURL = () => {
            try {
                if (window.location.protocol === 'blob:') return;
                const params = new URLSearchParams();
                if (state.view) params.set('v', state.view);
                if (state.currentType) params.set('type', state.currentType);
                if (state.currentTopic) params.set('topic', state.currentTopic);
                if (state.currentLevel) params.set('lv', state.currentLevel);

                const newURL = `${window.location.pathname}?${params.toString()}`;
                window.history.pushState(state, '', newURL);
            } catch (err) {}
        };

        window.onpopstate = (event) => {
            if (event.state) {
                Object.assign(state, event.state);
                render();
            } else {
                initFromURL();
            }
        };

        const initFromURL = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('v')) state.view = params.get('v');
            if (params.has('type')) state.currentType = params.get('type');
            if (params.has('topic')) state.currentTopic = params.get('topic');
            if (params.has('lv')) state.currentLevel = params.get('lv');
            render();
        };

        window.navigateTo = function(view, params = {}) {
            const protectedViews = ['english-selection', 'topics-grid', 'levels-grid', 'content-view', 'mistakes-book'];
            if (protectedViews.includes(view) && !state.isAuthenticated) {
                state.intendedView = view;
                state.intendedParams = params;
                state.view = 'login';
            } else {
                state.view = view;
            }
            Object.assign(state, params);
            updateURL();
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- RANK CALCULATOR ---
        function getMasteryRank(points) {
            if (points < 500) return { title: 'Junior Aspirant', icon: 'üå±', class: 'bg-slate-50 text-slate-500 border-slate-200' };
            if (points < 1500) return { title: 'Selection Warrior', icon: '‚öîÔ∏è', class: 'bg-indigo-50 text-indigo-600 border-indigo-200' };
            if (points < 3000) return { title: 'Master Aspirant', icon: 'üèÜ', class: 'bg-emerald-50 text-emerald-600 border-emerald-200' };
            return { title: 'Probationary Officer', icon: 'üèõÔ∏è', class: 'bg-amber-50 text-amber-700 border-amber-200' };
        }

        // --- CLOUD STORAGE LOGIC ---
        
        async function loadUserData() {
            if (!auth.currentUser) return;
            
            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'profile', 'info');
                const profileSnap = await getDoc(profileRef);
                if (profileSnap.exists()) {
                    state.userName = profileSnap.data().name || 'Aspirant';
                    state.isAuthenticated = true;
                }
            } catch (e) { console.error("Profile load fail:", e); }

            const progressRef = collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'progress');
            onSnapshot(progressRef, (snapshot) => {
                const updatedProgress = {};
                let points = 0;
                let coins = 0;
                snapshot.forEach(doc => { 
                    const data = doc.data();
                    updatedProgress[doc.id] = data; 
                    points += (data.points || 0);
                    coins += (data.coins || 0);
                });
                state.progress = updatedProgress;
                state.totalPoints = points;
                state.totalCoins = coins;
                render(); 
            }, (error) => console.error("Progress stream error:", error));

            const mistakesRef = collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'mistakes');
            onSnapshot(mistakesRef, (snapshot) => {
                const mistakes = [];
                snapshot.forEach(doc => mistakes.push({ id: doc.id, ...doc.data() }));
                state.mistakes = mistakes;
                if (state.view === 'mistakes-book' || state.view === 'home') render();
            });
        }

        async function loadLeaderboard() {
            const leaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(leaderboardRef, (snapshot) => {
                const list = [];
                snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                state.leaderboard = list.sort((a, b) => b.points - a.points).slice(0, 5);
                if (state.view === 'home') render();
            }, (error) => console.error("Leaderboard error:", error));
        }

        async function saveResultToCloud(score, total, points, coins, mistakesFound = []) {
            if (!auth.currentUser) return;
            const progressId = `${state.currentType}_${state.currentTopic}_${state.currentLevel}`;
            const docRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'progress', progressId);
            
            try {
                await setDoc(docRef, {
                    score, total, points, coins,
                    completedAt: new Date().toISOString(),
                    type: state.currentType, topic: state.currentTopic, level: state.currentLevel
                });

                for (const m of mistakesFound) {
                    const mId = btoa(m.question).substring(0, 20); 
                    const mRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'mistakes', mId);
                    await setDoc(mRef, {
                        ...m,
                        type: state.currentType,
                        topic: state.currentTopic,
                        level: state.currentLevel,
                        recordedAt: new Date().toISOString()
                    });
                }

                const leaderboardRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', auth.currentUser.uid);
                await setDoc(leaderboardRef, {
                    name: state.userName,
                    points: state.totalPoints + points,
                    coins: state.totalCoins + coins,
                    levelsDone: Object.keys(state.progress).length,
                    lastActive: new Date().toISOString()
                }, { merge: true });

            } catch (error) { console.error("Error saving progress:", error); }
        }

        window.removeMistake = async function(id) {
            if (!auth.currentUser) return;
            const mRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'mistakes', id);
            await deleteDoc(mRef);
        };

        // --- CORE RENDERER ---
        function render() {
            const shell = document.getElementById('app-shell');
            const authStatus = document.getElementById('auth-status');
            
            if (state.isAuthenticated) {
                authStatus.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-bold text-indigo-700">Hi, ${state.userName.split(' ')[0]}</span>
                        <button onclick="handleLogout()" class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center border border-indigo-100 hover:bg-red-50 hover:text-red-500 transition-colors">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        </button>
                    </div>
                `;
            } else {
                authStatus.innerHTML = `<button onclick="navigateTo('login')" class="px-6 py-2.5 text-xs font-bold bg-indigo-600 text-white rounded-full transition-all">Sign In</button>`;
            }

            switch(state.view) {
                case 'home': shell.innerHTML = renderHome(); break;
                case 'login': shell.innerHTML = renderLogin(); break;
                case 'english-selection': shell.innerHTML = renderEnglishSelection(); break;
                case 'topics-grid': shell.innerHTML = renderTopicsGrid(); break;
                case 'levels-grid': shell.innerHTML = renderLevelsGrid(); break;
                case 'content-view': shell.innerHTML = renderContentView(); loadContent(); break;
                case 'mistakes-book': shell.innerHTML = renderMistakesBook(); break;
                case 'doubts': shell.innerHTML = renderDoubts(); break;
            }
        }

        // --- TEMPLATES ---
        function renderHome() {
            const totalPossibleLevels = 10 * (topicsData.grammar.length + topicsData.vocabulary.length);
            const doneCount = Object.keys(state.progress).length;
            const percent = Math.round((doneCount / totalPossibleLevels) * 100);
            
            const grammarDone = Object.values(state.progress).filter(p => p.type === 'grammar').length;
            const vocabDone = Object.values(state.progress).filter(p => p.type === 'vocabulary').length;
            const grammarPct = Math.round((grammarDone / (10 * topicsData.grammar.length)) * 100);
            const vocabPct = Math.round((vocabDone / (10 * topicsData.vocabulary.length)) * 100);

            const rank = getMasteryRank(state.totalPoints);
            const recentStats = Object.values(state.progress)
                .sort((a,b) => new Date(b.completedAt) - new Date(a.completedAt))
                .slice(0, 5)
                .reverse();

            return `
                <div class="hero-gradient pt-16 pb-32 px-6 view-transition text-center">
                    <div class="max-w-7xl mx-auto">
                        <span class="inline-block px-4 py-1.5 bg-indigo-50 text-indigo-700 text-[10px] font-black rounded-full mb-6 border border-indigo-100 uppercase tracking-widest">Official roadmap 2026</span>
                        <h1 class="text-5xl md:text-7xl font-black text-slate-900 tracking-tighter mb-6 leading-[1.1]">
                            ${state.isAuthenticated ? `Mission <span class="text-indigo-600">Aspirant!</span><br>Prepare for Selection.` : `Secure Your <span class="text-indigo-600 italic">Officer Rank.</span>`}
                        </h1>
                        
                        ${state.isAuthenticated ? `
                            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8 mb-20">
                                <!-- Enhanced Statistics & Rank -->
                                <div class="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm text-left col-span-1">
                                    <div class="flex justify-between items-start mb-6">
                                        <div>
                                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">Mastery Progress</h4>
                                            <div class="rank-badge ${rank.class}">${rank.icon} ${rank.title}</div>
                                        </div>
                                        <span class="text-indigo-600 font-black text-2xl">${percent}%</span>
                                    </div>
                                    <div class="w-full h-3 bg-slate-50 rounded-full overflow-hidden mb-8">
                                        <div class="h-full bg-indigo-600" style="width: ${percent}%"></div>
                                    </div>
                                    
                                    <div class="space-y-4 mb-8">
                                        <div>
                                            <div class="flex justify-between text-[9px] font-black uppercase tracking-widest text-slate-400 mb-1"><span>Grammar Force</span><span>${grammarPct}%</span></div>
                                            <div class="w-full h-1.5 bg-slate-50 rounded-full overflow-hidden"><div class="h-full bg-indigo-400" style="width: ${grammarPct}%"></div></div>
                                        </div>
                                        <div>
                                            <div class="flex justify-between text-[9px] font-black uppercase tracking-widest text-slate-400 mb-1"><span>Vocab Strength</span><span>${vocabPct}%</span></div>
                                            <div class="w-full h-1.5 bg-slate-50 rounded-full overflow-hidden"><div class="h-full bg-emerald-400" style="width: ${vocabPct}%"></div></div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-3 gap-2 pt-6 border-t border-slate-50">
                                        <div><p class="text-lg font-black text-slate-900">${doneCount}</p><p class="text-[8px] text-slate-400 font-bold uppercase">Units</p></div>
                                        <div><p class="text-lg font-black text-emerald-600">${state.totalPoints}</p><p class="text-[8px] text-slate-400 font-bold uppercase">Points</p></div>
                                        <div><p class="text-lg font-black text-amber-500">ü™ô ${state.totalCoins}</p><p class="text-[8px] text-slate-400 font-bold uppercase">Coins</p></div>
                                    </div>
                                </div>
                                
                                <!-- Redesigned Activity Velocity -->
                                <div class="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm text-left">
                                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Learning Velocity</h4>
                                    <div class="flex items-end gap-3 h-32 mb-8">
                                        ${recentStats.length > 0 ? recentStats.map(s => `
                                            <div class="flex-1 bg-slate-50 rounded-xl group relative h-full flex items-end overflow-hidden">
                                                <div class="w-full bg-indigo-600 graph-bar" style="height: ${Math.max(15, (s.score/s.total)*100)}%"></div>
                                                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-slate-900/10 pointer-events-none">
                                                    <span class="text-[8px] font-black text-indigo-900 bg-white px-1.5 py-0.5 rounded-md shadow-sm">${s.score}/${s.total}</span>
                                                </div>
                                            </div>
                                        `).join('') : '<p class="text-slate-300 text-[10px] italic flex items-center h-full">Complete levels to generate graph</p>'}
                                    </div>
                                    <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100 flex items-center gap-4">
                                        <div class="text-2xl">‚ö°</div>
                                        <div>
                                            <p class="text-[10px] font-black text-indigo-700 uppercase tracking-widest">Aspirant Insight</p>
                                            <p class="text-xs text-indigo-600 font-medium leading-tight">Your accuracy is trending upwards. Keep the momentum!</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Leaderboard Small -->
                                <div class="bg-slate-900 p-8 rounded-[3rem] text-white text-left overflow-hidden relative border border-white/5">
                                    <h4 class="text-xs font-black text-indigo-300 uppercase tracking-widest mb-6">State Rankings</h4>
                                    <div class="space-y-4">
                                        ${state.leaderboard.length > 0 ? state.leaderboard.map((u, i) => `
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-3">
                                                    <span class="text-[10px] font-bold ${i === 0 ? 'text-amber-400' : 'text-slate-500'}">#${i+1}</span>
                                                    <span class="text-sm font-bold truncate max-w-[100px]">${u.name}</span>
                                                </div>
                                                <span class="text-indigo-400 font-black text-xs">${u.points} PTS</span>
                                            </div>
                                        `).join('') : '<p class="text-slate-500 text-xs italic">Syncing global data...</p>'}
                                    </div>
                                    <button onclick="navigateTo('mistakes-book')" class="mt-8 w-full py-4 bg-indigo-600 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-900/50">Open Mistakes Book (${state.mistakes.length})</button>
                                </div>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-left">
                            <div onclick="navigateTo('english-selection')" class="premium-card group">
                                <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-all">üá¨üáß</div>
                                <h3 class="text-2xl font-bold mb-2 tracking-tight">General English</h3>
                                <p class="text-slate-500 text-sm mb-6 leading-relaxed">Levels 1-10 Grammar & Vocabulary mastery roadmap.</p>
                                <span class="text-indigo-600 text-xs font-bold uppercase tracking-widest">Mastery Hub ‚ûú</span>
                            </div>
                            <div onclick="navigateTo('mistakes-book')" class="premium-card group border-rose-50 hover:border-rose-200">
                                <div class="w-14 h-14 bg-rose-50 text-rose-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-rose-600 group-hover:text-white transition-all">üìì</div>
                                <h3 class="text-2xl font-bold mb-2 tracking-tight">Mistakes Book</h3>
                                <p class="text-slate-500 text-sm mb-6">Automated notebook for every error you've ever made. Revision Sync.</p>
                                <span class="text-rose-600 text-xs font-bold uppercase tracking-widest">Self-Revision ‚ûú</span>
                            </div>
                            <div onclick="navigateTo('doubts')" class="premium-card group border-emerald-50 hover:border-emerald-200">
                                <div class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-emerald-600 group-hover:text-white transition-all">üí¨</div>
                                <h3 class="text-2xl font-bold mb-2 tracking-tight">Expert Support</h3>
                                <p class="text-slate-500 text-sm mb-6">Direct access to mentors via private WhatsApp and Telegram sync.</p>
                                <span class="text-emerald-600 text-xs font-bold uppercase tracking-widest">Ask mentor ‚ûú</span>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function renderMistakesBook() {
            const grammarMistakes = state.mistakes.filter(m => m.type === 'grammar');
            const vocabMistakes = state.mistakes.filter(m => m.type === 'vocabulary');

            return `
                <div class="max-w-6xl mx-auto px-6 py-20 view-transition">
                    <button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center gap-2 hover:text-indigo-600 transition-colors uppercase text-xs tracking-widest">‚Üê Dashboard</button>
                    <div class="flex flex-col lg:flex-row justify-between items-start gap-8 mb-12">
                        <div class="max-w-xl">
                            <span class="px-4 py-1 bg-rose-50 text-rose-700 text-[10px] font-black rounded-full uppercase tracking-widest mb-4 inline-block border border-rose-100">Critical Intelligence</span>
                            <h2 class="text-5xl font-black text-slate-900 tracking-tighter capitalize">The Mistakes Book</h2>
                            <p class="text-slate-500 mt-4">This automated notebook identifies patterns in your errors. Mastering these ${state.mistakes.length} concepts is your final step to a perfect score.</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="bg-white border border-slate-100 p-6 rounded-3xl text-center shadow-sm">
                                <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Grammar Fixes</p>
                                <p class="text-2xl font-black text-indigo-600">${grammarMistakes.length}</p>
                            </div>
                            <div class="bg-white border border-slate-100 p-6 rounded-3xl text-center shadow-sm">
                                <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Vocab Fixes</p>
                                <p class="text-2xl font-black text-emerald-600">${vocabMistakes.length}</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${state.mistakes.length === 0 ? `
                            <div class="col-span-full bg-white p-20 rounded-[4rem] text-center border-2 border-dashed border-slate-200">
                                <div class="text-6xl mb-6 text-slate-200">üíé</div>
                                <p class="text-slate-400 font-black uppercase tracking-widest text-xs">Error Log is Clean. You are operating at peak precision.</p>
                            </div>
                        ` : state.mistakes.map(m => `
                            <div class="bg-white border-2 border-slate-100 rounded-[3rem] p-8 transition-all hover:border-rose-200 shadow-sm relative group overflow-hidden">
                                <div class="flex justify-between items-center mb-6">
                                    <div class="flex items-center gap-2">
                                        <span class="px-3 py-1 ${m.type === 'grammar' ? 'bg-indigo-50 text-indigo-600 border-indigo-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100'} rounded-full text-[8px] font-black uppercase tracking-widest border capitalize">${m.topic}</span>
                                        <span class="text-[8px] font-black text-slate-300 uppercase tracking-widest">Lv ${m.level}</span>
                                    </div>
                                    <button onclick="removeMistake('${m.id}')" class="text-slate-300 hover:text-emerald-500 transition-all font-black text-[10px] uppercase">‚úì Resolve</button>
                                </div>
                                <h3 class="text-xl font-bold text-slate-900 mb-6 leading-relaxed">"${m.question}"</h3>
                                <div class="grid grid-cols-2 gap-3 mb-8">
                                    <div class="bg-rose-50/50 p-4 rounded-2xl border border-rose-100/50">
                                        <p class="text-[7px] font-black text-rose-400 uppercase mb-1">Error Made</p>
                                        <p class="text-sm font-bold text-rose-900">${m.userAnswer}</p>
                                    </div>
                                    <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                                        <p class="text-[7px] font-black text-emerald-600 uppercase mb-1">Selection Goal</p>
                                        <p class="text-sm font-bold text-emerald-900">${m.answer}</p>
                                    </div>
                                </div>
                                <div class="bg-slate-50 p-6 rounded-3xl">
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">Explanation</p>
                                    <p class="text-sm text-slate-600 font-medium leading-relaxed italic">${m.explanation}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderLogin() {
            const isLogin = state.authMode === 'login';
            return `
                <div class="max-w-md mx-auto px-6 py-24 view-transition text-center">
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-2">${isLogin ? 'Mission Login' : 'Join Academy'}</h2>
                    <p class="text-slate-500 mb-10 font-medium">${isLogin ? 'Continue your selection roadmap.' : 'Create an ID to track your points and rank.'}</p>
                    
                    <form id="login-form" class="bg-white border border-slate-200 p-10 rounded-[3rem] shadow-sm text-left">
                        ${!isLogin ? `
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Full Name</label>
                            <input id="name-input" type="text" placeholder="Your Display Name" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold mb-6 focus:bg-white transition-all" required>
                        ` : ''}
                        
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Username</label>
                        <input id="username-input" type="text" placeholder="aspirant_id" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold mb-6 focus:bg-white transition-all" required>
                        
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Password</label>
                        <input id="password-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold mb-8 focus:bg-white transition-all" required>
                        
                        <button type="submit" id="login-btn" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-xl active:scale-95 transition-all uppercase tracking-widest text-xs">
                            ${isLogin ? 'Authorize Entry' : 'Enroll in Academy'}
                        </button>

                        <div class="mt-8 text-center">
                            <p class="text-slate-400 text-xs font-bold">
                                ${isLogin ? "New to the mission?" : "Already enrolled?"}
                                <button type="button" onclick="toggleAuthMode()" class="text-indigo-600 hover:underline ml-1">
                                    ${isLogin ? 'Create Account' : 'Login Now'}
                                </button>
                            </p>
                        </div>
                    </form>
                </div>`;
        }

        window.toggleAuthMode = function() {
            state.authMode = state.authMode === 'login' ? 'signup' : 'login';
            render();
        };

        function renderEnglishSelection() {
            return `
                <div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                    <button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Dashboard</button>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-12">Select Roadmap</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 text-left">
                        <div onclick="navigateTo('topics-grid', { currentType: 'grammar' })" class="premium-card group">
                            <span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-[9px] font-black rounded-full uppercase tracking-widest mb-6 inline-block">Rule System</span>
                            <h3 class="text-3xl font-black mb-4 tracking-tight">English Grammar</h3>
                            <p class="text-slate-500 mb-8 leading-relaxed">Conceptual foundations for FDA, SDA and SSC recruitment.</p>
                            <span class="text-indigo-600 font-bold text-sm uppercase tracking-widest">Start Units ‚ûú</span>
                        </div>
                        <div onclick="navigateTo('topics-grid', { currentType: 'vocabulary' })" class="premium-card group">
                            <span class="px-3 py-1 bg-emerald-50 text-emerald-700 text-[9px] font-black rounded-full uppercase tracking-widest mb-6 inline-block">Recall System</span>
                            <h3 class="text-3xl font-black mb-4 tracking-tight">Vocabulary Hub</h3>
                            <p class="text-slate-500 mb-8 leading-relaxed">Bilingual mappings for Synonyms, Antonyms and Idioms.</p>
                            <span class="text-emerald-600 font-bold text-sm uppercase tracking-widest">Start Units ‚ûú</span>
                        </div>
                    </div>
                </div>`;
        }

        function renderTopicsGrid() {
            const topics = topicsData[state.currentType];
            return `
                <div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                    <button onclick="navigateTo('english-selection')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Category</button>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter capitalize mb-12">${state.currentType} Units</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 text-left">
                        ${topics.map(t => `
                            <div onclick="navigateTo('levels-grid', { currentTopic: '${t.id}', currentTopicTitle: '${t.title}' })" class="premium-card p-10 group">
                                <div class="text-5xl mb-8 group-hover:scale-125 transition-transform duration-500">${t.icon}</div>
                                <h3 class="text-xl font-bold text-slate-900 mb-4 tracking-tight">${t.title}</h3>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Phases 1-10 Active</p>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }

        function renderLevelsGrid() {
            return `
                <div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                    <button onclick="navigateTo('topics-grid')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Units</button>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-16">${state.currentTopicTitle} Progress</h2>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                        ${Array.from({length: 10}, (_, i) => i + 1).map(lv => {
                            const progressId = `${state.currentType}_${state.currentTopic}_${lv}`;
                            const isDone = state.progress[progressId];

                            return `
                                <div onclick="handleLevelClick(${lv}, '${progressId}')" 
                                    class="p-10 border-2 ${isDone ? 'border-emerald-500 bg-emerald-50/30' : 'border-slate-100 bg-white'} rounded-[2.5rem] text-center hover:border-indigo-600 hover:shadow-2xl transition-all cursor-pointer group shadow-sm relative overflow-hidden">
                                    
                                    ${isDone ? `
                                        <div class="absolute top-4 right-4 text-emerald-600 font-black text-[10px] bg-emerald-100 px-2 py-0.5 rounded-full flex items-center gap-1 shadow-sm border border-emerald-200">
                                            <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="4" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>
                                            DONE
                                        </div>
                                    ` : ''}

                                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2 block group-hover:text-indigo-600">Phase</span>
                                    <span class="text-4xl font-black text-slate-900">${lv}</span>
                                    
                                    ${isDone ? `<p class="mt-4 text-[9px] font-black text-emerald-600 uppercase tracking-widest">Reattempt Available</p>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>`;
        }

        window.handleLevelClick = function(lv, progressId) {
            const isDone = state.progress[progressId];
            if (isDone) {
                const container = document.getElementById('app-shell');
                container.innerHTML = `
                    <div class="max-w-xl mx-auto py-32 px-6 text-center view-transition">
                        <div class="bg-white border-2 border-emerald-100 p-12 rounded-[3.5rem] shadow-xl">
                            <span class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-3xl mb-8 mx-auto">üèÜ</span>
                            <h2 class="text-3xl font-black text-slate-900 mb-2">Level ${lv} Completed</h2>
                            <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px] mb-8">Success Rate: ${isDone.score}/${isDone.total}</p>
                            
                            <div class="space-y-4">
                                <button onclick="navigateTo('content-view', { currentLevel: ${lv} })" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl shadow-indigo-100 transition-all uppercase tracking-widest text-xs">Review Flashcards</button>
                                <button onclick="loadTestExplicitly(${lv})" class="w-full py-5 border-2 border-slate-100 text-slate-600 font-black rounded-2xl hover:bg-slate-50 transition-all uppercase tracking-widest text-xs">Reattempt Quiz</button>
                                <button onclick="navigateTo('levels-grid')" class="w-full py-2 text-slate-300 font-bold uppercase tracking-widest text-[10px] mt-4">Close Mastery</button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                navigateTo('content-view', { currentLevel: lv });
            }
        };

        window.loadTestExplicitly = function(lv) {
            state.currentLevel = lv;
            state.view = 'content-view';
            render();
            loadTest();
        };

        function renderContentView() {
            return `
                <div class="max-w-7xl mx-auto px-6 py-20 view-transition">
                    <button onclick="navigateTo('levels-grid')" class="text-slate-400 font-bold flex items-center gap-2 hover:text-indigo-600 transition-colors mb-12 uppercase text-xs tracking-widest">‚Üê Levels</button>
                    <div id="content-container"></div>
                </div>`;
        }

        window.loadContent = async function() {
            const container = document.getElementById('content-container');
            container.innerHTML = `<div class="flex flex-col items-center justify-center py-24"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div><p class="text-slate-400 text-[10px] font-bold animate-pulse uppercase tracking-widest">Opening Lesson Case...</p></div>`;
            
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const absoluteURL = getDynamicPath(type, topic, level, false);

            try {
                const response = await fetch(absoluteURL);
                if (!response.ok) throw new Error(`${response.status}`);
                const data = await response.json();
                renderFlashcards(data);
            } catch (err) {
                showErrorState(container, absoluteURL, err.message);
            }
        };

        window.loadTest = async function() {
            const container = document.getElementById('content-container');
            container.innerHTML = `<div class="flex flex-col items-center justify-center py-24"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mb-4"></div><p class="text-slate-400 text-[10px] font-bold animate-pulse uppercase tracking-widest">Calibrating Quiz...</p></div>`;
            
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const absoluteURL = getDynamicPath(type, topic, level, true);

            try {
                const response = await fetch(absoluteURL);
                if (!response.ok) throw new Error(`${response.status}`);
                const data = await response.json();
                renderTest(data);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) {
                showErrorState(container, absoluteURL, err.message);
            }
        };

        function renderFlashcards(notes) {
            const container = document.getElementById('content-container');
            const randomQuote = testMotivationalQuotes[Math.floor(Math.random() * testMotivationalQuotes.length)];
            
            let html = `
                <div class="mb-16 text-center lg:text-left">
                    <span class="px-4 py-1 bg-indigo-50 text-indigo-700 text-[10px] font-black rounded-full uppercase tracking-widest mb-4 inline-block border border-indigo-100">Bilingual Learning Phase</span>
                    <h2 class="text-5xl font-black text-slate-900 tracking-tighter capitalize">${state.currentTopic} Case - Lv ${state.currentLevel}</h2>
                    <p class="text-slate-400 text-sm mt-4 font-bold max-w-2xl">Use Active Recall technology. Try to guess the Kannada meaning before revealing the card.</p>
                </div>
                <div class="flashcard-container">`;

            notes.forEach((item, index) => {
                const synonyms = (item.meaning_english || "").replace(/_/g, ', ');
                html += `
                    <div class="flashcard group border-slate-50" id="card-${index}">
                        <div class="w-14 h-14 bg-slate-50 rounded-full flex items-center justify-center text-3xl mb-8 border border-slate-100 group-hover:scale-110 transition-transform">${item.emoji || 'üìó'}</div>
                        <h3 class="text-3xl font-black text-slate-900 tracking-tighter mb-2">${item.word}</h3>
                        <p class="text-[8px] font-black text-slate-300 uppercase tracking-widest">Entry ID: #${index+1}</p>
                        
                        <button class="reveal-btn" onclick="revealCard(${index})">Open Translation</button>
                        
                        <div class="flashcard-answer">
                            <div class="space-y-4">
                                <div class="p-5 bg-emerald-50 rounded-[2rem] border border-emerald-100 text-center">
                                    <p class="text-[8px] font-black text-emerald-600 uppercase tracking-widest mb-2">Meaning (Kannada)</p>
                                    <p class="text-2xl font-bold text-slate-900 font-kannada">${item.meaning_kannada || ""}</p>
                                </div>
                                <div class="p-5 bg-indigo-50 rounded-[2rem] border border-indigo-100 text-center">
                                    <p class="text-[8px] font-black text-indigo-600 uppercase tracking-widest mb-2">Usage Context</p>
                                    <p class="text-sm font-bold text-indigo-900 leading-tight">${synonyms}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
            
            html += `
                <div class="col-span-full p-20 bg-slate-900 rounded-[4rem] text-white text-center shadow-2xl mt-12 relative overflow-hidden group w-full border border-white/10">
                    <div class="relative z-10">
                        <h3 class="text-4xl font-black mb-4 tracking-tight">Phase Ready</h3>
                        <p class="text-emerald-400 mb-8 text-xl font-bold italic leading-relaxed">"${randomQuote}"</p>
                        <button onclick="loadTest()" class="px-16 py-6 bg-white text-slate-900 font-black rounded-3xl shadow-xl hover:bg-slate-50 transition-all uppercase tracking-widest text-[10px] active:scale-95">
                            Launch Final Quiz ‚ûú
                        </button>
                    </div>
                    <div class="absolute -right-10 -bottom-10 text-white opacity-[0.03] text-[15rem] font-black rotate-12">TEST</div>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }

        function renderTest(questions) {
            const container = document.getElementById('content-container');
            container.innerHTML = `
                <div class="mb-12 view-transition text-center lg:text-left">
                    <button onclick="loadContent()" class="text-slate-400 font-bold flex items-center gap-2 hover:text-indigo-600 transition-colors mb-8 uppercase text-[10px] tracking-widest">‚Üê Back to Cards</button>
                    <span class="px-4 py-1 bg-emerald-50 text-emerald-700 text-[10px] font-black rounded-full uppercase tracking-widest mb-4 inline-block border border-emerald-100">Performance Check</span>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter capitalize">${state.currentTopic} Quiz - Level ${state.currentLevel}</h2>
                </div>
                <div id="quiz-list" class="space-y-6"></div>
            `;

            const quizList = document.getElementById('quiz-list');

            questions.forEach((q, index) => {
                const div = document.createElement("div");
                div.className = "bg-white p-8 md:p-10 border-2 border-slate-50 rounded-[3rem] shadow-sm";

                div.innerHTML = `
                    <div class="flex items-start gap-4 mb-8">
                        <span class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center text-xs font-bold shrink-0">${index + 1}</span>
                        <p class="text-xl font-bold text-slate-800 leading-tight pt-1">${q.question}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${q.options.map(option => `
                            <label class="flex items-center gap-4 px-8 py-5 border-2 border-slate-50 rounded-[2rem] font-semibold text-slate-600 hover:bg-slate-50 cursor-pointer transition-all has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50 has-[:checked]:text-indigo-900">
                                <input type="radio" name="q${index}" value="${option}" class="w-5 h-5 accent-indigo-600">
                                <span class="text-base">${option}</span>
                            </label>
                        `).join("")}
                    </div>
                `;
                quizList.appendChild(div);
            });

            const submitBtn = document.createElement("button");
            submitBtn.innerText = "Submit Intelligence Report";
            submitBtn.className = "w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-2xl shadow-indigo-100 hover:bg-indigo-700 active:scale-95 transition-all uppercase tracking-widest text-[12px] mt-10 mb-20";
            submitBtn.onclick = () => submitTest(questions);

            quizList.appendChild(submitBtn);
        }

        window.submitTest = async function(questions) {
            let score = 0;
            let wrongCount = 0;
            let unattemptedCount = 0;
            let resultHTML = "";
            let mistakesFound = [];

            questions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                
                let bgColor = "bg-slate-50 border-slate-100";
                let statusText = "Not Attempted";
                let statusColor = "text-amber-500";

                if (selected) {
                    const isCorrect = selected.value.trim() === q.answer.trim();
                    if (isCorrect) {
                        score++;
                        bgColor = "bg-emerald-50 border-emerald-100";
                        statusText = "Perfect Mastery";
                        statusColor = "text-emerald-600";
                    } else {
                        wrongCount++;
                        bgColor = "bg-rose-50 border-rose-100";
                        statusText = "Concept Failed";
                        statusColor = "text-rose-500";
                        mistakesFound.push({
                            question: q.question,
                            userAnswer: selected.value,
                            answer: q.answer,
                            explanation: q.explanation
                        });
                    }
                } else {
                    unattemptedCount++;
                    bgColor = "bg-amber-50/50 border-amber-100";
                    statusText = "Skipped Case";
                    statusColor = "text-amber-500";
                }

                resultHTML += `
                    <div class="${bgColor} p-10 rounded-[3.5rem] mb-6 border transition-all">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <span class="w-8 h-8 rounded-full bg-white border flex items-center justify-center text-xs font-bold text-slate-400">#${index + 1}</span>
                                <p class="text-xs font-black uppercase tracking-widest ${statusColor}">${statusText}</p>
                            </div>
                        </div>
                        <p class="text-slate-800 font-bold mb-6 text-xl leading-relaxed">"${q.question}"</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="bg-white/60 p-5 rounded-3xl border border-white">
                                <p class="text-[9px] font-black text-slate-400 uppercase mb-2">Aspirant Input</p>
                                <p class="text-sm font-bold ${selected ? 'text-slate-800' : 'text-slate-400 italic'}">${selected ? selected.value : 'No response'}</p>
                            </div>
                            <div class="bg-emerald-500/10 p-5 rounded-3xl border border-emerald-100/50">
                                <p class="text-[9px] font-black text-emerald-600 uppercase mb-2">Selection Goal</p>
                                <p class="text-sm font-bold text-emerald-700">${q.answer}</p>
                            </div>
                        </div>
                        <div class="mt-8 pt-8 border-t border-white/50">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Logic Sync</p>
                            <p class="text-sm text-slate-600 italic font-medium leading-relaxed">${q.explanation || 'Review the unit cards for mapping.'}</p>
                        </div>
                    </div>
                `;
            });

            const coinsEarned = score; 
            const coinsDeducted = Math.floor(wrongCount / 4); 
            const pointsEarned = score * 10;

            await saveResultToCloud(score, questions.length, pointsEarned, coinsEarned - coinsDeducted, mistakesFound);

            const container = document.getElementById("content-container");
            container.innerHTML = `
                <div class="view-transition">
                    <div class="bg-white border-2 border-slate-100 p-16 rounded-[4rem] shadow-sm text-center mb-10 relative overflow-hidden">
                        <div class="flex justify-center gap-10 mb-10">
                            <div class="text-center">
                                <p class="text-4xl font-black text-emerald-600">ü™ô +${coinsEarned}</p>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Bounty Gained</p>
                            </div>
                            <div class="w-px h-12 bg-slate-100 self-center"></div>
                            <div class="text-center">
                                <p class="text-4xl font-black text-rose-500">ü™ô -${coinsDeducted}</p>
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Penalty Paid</p>
                            </div>
                        </div>
                        
                        <h2 class="text-5xl font-black text-slate-900 mb-4 tracking-tighter">Phase Report</h2>
                        <div class="flex justify-center items-baseline gap-2 mb-12">
                            <span class="text-[6rem] font-black text-indigo-600 leading-none">${score}</span>
                            <span class="text-3xl font-bold text-slate-300">/ ${questions.length}</span>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-6 justify-center">
                            <button onclick="loadContent()" class="px-12 py-5 bg-slate-900 text-white font-black rounded-2xl hover:bg-slate-800 transition-all uppercase tracking-widest text-[10px]">Review Errors</button>
                            <button onclick="navigateTo('levels-grid')" class="px-12 py-5 border-2 border-slate-200 text-slate-600 font-black rounded-2xl hover:bg-slate-50 transition-all uppercase tracking-widest text-[10px]">Next Phase ‚ûú</button>
                        </div>
                    </div>
                    
                    <div class="mb-20">
                        <h3 class="text-2xl font-black text-slate-900 mb-10 tracking-tight px-4 uppercase tracking-[0.1em]">Detailed Mastery Log</h3>
                        ${resultHTML}
                    </div>
                </div>
            `;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function showErrorState(container, url, error) {
            container.innerHTML = `
                <div class="text-center py-24 bg-white border border-slate-200 rounded-[4rem] shadow-sm px-10">
                    <div class="text-7xl mb-8">üìÅ</div>
                    <h3 class="text-2xl font-bold text-slate-900 mb-4 tracking-tight">Phase Offline</h3>
                    <code class="bg-slate-50 p-4 rounded-3xl text-indigo-600 mb-10 block text-[10px] font-bold border border-indigo-50 break-all max-w-md mx-auto">${url}</code>
                    <p class="text-slate-400 text-xs mb-10">Verification required: Did you push the latest content to your GitHub repository?</p>
                    <button onclick="navigateTo('levels-grid')" class="px-12 py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl active:scale-95 transition-all uppercase text-[10px] tracking-widest">Return to Roadmap</button>
                </div>`;
        }

        window.revealCard = function(index) {
            const card = document.getElementById(`card-${index}`);
            if (card) card.classList.add('revealed');
        };

        window.handleLogout = async function() { 
            await signOut(auth);
            state.isAuthenticated = false; 
            state.userName = ''; 
            state.progress = {};
            state.totalPoints = 0;
            state.totalCoins = 0;
            state.mistakes = [];
            navigateTo('home'); 
        };
        
        async function handleLogin(event) {
            event.preventDefault();
            const usernameInput = document.getElementById('username-input');
            const passwordInput = document.getElementById('password-input');
            const loginBtn = document.getElementById('login-btn');
            const isSignUp = state.authMode === 'signup';
            
            if (usernameInput.value.length < 3) return alert("ID too short.");

            const internalEmail = `${usernameInput.value.toLowerCase()}@prepease.internal`;
            const password = passwordInput.value;

            loginBtn.innerText = "Securing Identity...";
            loginBtn.disabled = true;

            try {
                if (isSignUp) {
                    const name = document.getElementById('name-input').value;
                    const cred = await createUserWithEmailAndPassword(auth, internalEmail, password);
                    const profileRef = doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile', 'info');
                    await setDoc(profileRef, { name: name, username: usernameInput.value, joinedAt: new Date().toISOString() });
                    state.userName = name;
                } else {
                    await signInWithEmailAndPassword(auth, internalEmail, password);
                }
                
                state.isAuthenticated = true;
                navigateTo(state.intendedView || 'home', state.intendedParams);
                state.intendedView = null;
            } catch (error) {
                console.error("Auth Error:", error);
                alert("Authorization Denied. Check ID/Password.");
                loginBtn.innerText = isSignUp ? 'Enroll Now' : 'Authorize Entry';
                loginBtn.disabled = false;
            }
        }

        window.renderExamsPYQ = function() { return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center"><button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Dashboard</button><h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-12 capitalize">${state.currentCategory} Hub</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left"><div class="premium-card flex justify-between items-center group"><div><h3 class="text-2xl font-bold text-slate-900 mb-1 tracking-tight">Official Archives 2024</h3><p class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest">Verified Log</p></div><div class="w-14 h-14 bg-slate-50 border border-slate-100 rounded-2xl flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-all"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg></div></div></div></div>`; };
        
        window.renderDoubts = function() { 
            return `
                <div class="max-w-4xl mx-auto px-6 py-20 text-center view-transition">
                    <div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-[2.5rem] flex items-center justify-center text-4xl mx-auto mb-8 shadow-sm">üí°</div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-4">Mentor Sync</h2>
                    <p class="text-slate-500 mb-12 max-w-xl mx-auto font-medium">Stuck on a rule? Our selection mentors are ready to clear your paths via priority channels.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                        <div onclick="window.open('https://t.me/prepeaseengl')" class="premium-card border-indigo-100 bg-indigo-50/20">
                            <span class="w-12 h-12 bg-indigo-600 text-white rounded-2xl flex items-center justify-center text-xl mb-6">üì¢</span>
                            <h3 class="text-2xl font-black text-slate-900 mb-2">Telegram Academy</h3>
                            <p class="text-slate-500 text-sm mb-6">Daily vocabulary, community discussions, and instant rule updates.</p>
                            <span class="text-indigo-600 font-bold text-[10px] uppercase tracking-widest">Connect Hub ‚ûú</span>
                        </div>
                        
                        <div onclick="askDoubtOnWA()" class="premium-card border-emerald-100 bg-emerald-50/20">
                            <span class="w-12 h-12 bg-emerald-600 text-white rounded-2xl flex items-center justify-center text-xl mb-6">üí¨</span>
                            <h3 class="text-2xl font-black text-slate-900 mb-2">Private WhatsApp</h3>
                            <p class="text-slate-500 text-sm mb-6">Private mentor access. Ask complex doubts and receive 1-on-1 logic.</p>
                            <span class="text-emerald-600 font-bold text-[10px] uppercase tracking-widest">Ask Private Doubt ‚ûú</span>
                        </div>
                    </div>

                    <button onclick="navigateTo('home')" class="mt-20 py-5 px-10 bg-slate-900 text-white font-bold rounded-[2rem] hover:bg-slate-800 transition-all uppercase tracking-widest text-[10px]">Return to Mission</button>
                </div>`; 
        };

        window.askDoubtOnWA = function() {
            const name = state.userName || 'Aspirant';
            const text = encodeURIComponent(`Hello PrepEase Mentor, I am ${name}. I have a doubt regarding my English studies...`);
            window.open(`https://wa.me/918088165696?text=${text}`, '_blank');
        };

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.userId = user.uid;
                await loadUserData();
                loadLeaderboard();
            } else {
                state.isAuthenticated = false;
                state.userName = '';
                state.progress = {};
                state.mistakes = [];
                render();
            }
        });

        // --- APP INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initFromURL();
            
            document.addEventListener('click', (e) => {
                if (e.target.closest('#nav-logo')) navigateTo('home');
                if (e.target.closest('#btn-home')) navigateTo('home');
                if (e.target.closest('#btn-doubts')) navigateTo('doubts');
                if (e.target.closest('#btn-mistakes')) navigateTo('mistakes-book');
            });

            document.addEventListener('submit', (e) => {
                if (e.target.id === 'login-form') handleLogin(e);
            });
        });

        // --- MOTTO CYCLE ---
        let quoteIndex = 0;
        setInterval(() => {
            const el = document.getElementById('moto-text');
            if (!el) return;
            el.className = "text-[10px] md:text-xs font-bold uppercase tracking-[0.25em] inline-block fade-out";
            setTimeout(() => {
                quoteIndex = (quoteIndex + 1) % quotes.length;
                el.innerText = quotes[quoteIndex];
                el.className = "text-[10px] md:text-xs font-bold uppercase tracking-[0.25em] inline-block fade-in";
            }, 500);
        }, 5000);
    </script>
</body>
</html>
