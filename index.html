<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrepEase | Karnataka & SSC Mastery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { scroll-behavior: smooth; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a; 
            overflow-x: hidden; 
        }
        
        .hero-gradient {
            background: radial-gradient(circle at 100% 0%, rgba(67, 56, 202, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 0% 100%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            background-color: #ffffff;
        }

        .premium-card {
            @apply bg-white border border-slate-200 rounded-[2.5rem] p-8 transition-all duration-500 cursor-pointer;
            box-shadow: 0 4px 12px -2px rgba(15, 23, 42, 0.03);
        }

        .premium-card:hover {
            @apply -translate-y-2;
            box-shadow: 0 20px 30px -10px rgba(67, 56, 202, 0.12);
            border-color: rgba(67, 56, 202, 0.3);
        }

        /* ANKI CARD Challenge STYLES */
        .anki-card {
            perspective: 1000px;
            height: 520px;
            width: 100%;
        }
        .anki-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .anki-card.flipped .anki-card-inner {
            transform: rotateY(180deg);
        }
        .anki-front, .anki-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            @apply rounded-[3.5rem] border-2 p-8 flex flex-col justify-center items-center;
        }
        .anki-front { @apply border-slate-100 bg-white shadow-xl shadow-slate-100/50; }
        .anki-back { 
            @apply border-indigo-100 bg-indigo-50 shadow-2xl shadow-indigo-100/50;
            transform: rotateY(180deg);
        }

        /* DRAWER NAVIGATION */
        #drawer {
            @apply fixed top-0 right-0 h-full w-[340px] bg-white z-[100] shadow-2xl transition-transform duration-500 translate-x-full border-l border-slate-100;
        }
        #drawer.open { @apply translate-x-0; }
        .drawer-overlay {
            @apply fixed inset-0 bg-slate-900/40 z-[90] opacity-0 pointer-events-none transition-opacity duration-500;
        }
        .drawer-overlay.open { @apply opacity-100 pointer-events-auto backdrop-blur-sm; }

        .font-kannada { line-height: 1.6; }
        
        .progress-container {
            @apply w-full bg-slate-100 h-2 rounded-full overflow-hidden mb-2;
        }
        .progress-fill {
            @apply bg-indigo-600 h-full transition-all duration-1000;
        }

        @keyframes box-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .logo-box { animation: box-pulse 4s ease-in-out infinite; }

        .view-transition { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .graph-bar { transition: height 1s ease-out; }
    </style>
</head>
<body>

    <!-- SIDE DRAWER MENU -->
    <div id="drawer-overlay" class="drawer-overlay" onclick="toggleDrawer()"></div>
    <aside id="drawer">
        <div class="p-8 h-full flex flex-col overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Aspirant Profile</h3>
                <button onclick="toggleDrawer()" class="p-2 hover:bg-slate-50 rounded-full">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>

            <div class="mb-8 p-6 bg-slate-50 rounded-[2.5rem] border border-slate-100 text-center">
                <div class="w-20 h-20 bg-indigo-600 text-white rounded-full flex items-center justify-center text-3xl font-black mx-auto mb-4 shadow-lg shadow-indigo-100" id="drawer-avatar">?</div>
                <h4 id="drawer-name" class="font-bold text-lg text-slate-900 leading-tight">Guest</h4>
                <p id="drawer-rank" class="text-[10px] font-black text-indigo-600 uppercase tracking-widest mt-1 mb-6">Mastery Level 0</p>
                
                <div class="text-left mb-6">
                    <div class="flex justify-between text-[9px] font-black uppercase text-slate-400 mb-2">
                        <span>Overall Progress</span>
                        <span id="drawer-percent">0%</span>
                    </div>
                    <div class="progress-container">
                        <div id="drawer-progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-left mb-3">Learning Velocity</p>
                <div id="drawer-velocity" class="flex items-end gap-1.5 h-10">
                    <!-- Velocity Bars -->
                </div>
            </div>

            <nav class="space-y-2 flex-1">
                <button onclick="navigateTo('home'); toggleDrawer();" class="w-full flex items-center gap-4 p-4 hover:bg-indigo-50 rounded-2xl transition-all group text-left">
                    <span class="text-xl">üè†</span>
                    <span class="font-bold text-sm text-slate-600 group-hover:text-indigo-700">Dashboard</span>
                </button>
                <button onclick="navigateTo('mistakes-book'); toggleDrawer();" class="w-full flex items-center gap-4 p-4 hover:bg-rose-50 rounded-2xl transition-all group text-left">
                    <span class="text-xl">üìì</span>
                    <span class="font-bold text-sm text-slate-600 group-hover:text-rose-700">Mistakes Book</span>
                </button>
                <button onclick="navigateTo('doubts'); toggleDrawer();" class="w-full flex items-center gap-4 p-4 hover:bg-emerald-50 rounded-2xl transition-all group text-left">
                    <span class="text-xl">üí¨</span>
                    <span class="font-bold text-sm text-slate-600 group-hover:text-emerald-700">Contact Mentor</span>
                </button>
            </nav>

            <button onclick="handleLogout()" class="w-full py-4 text-xs font-black text-rose-500 uppercase tracking-widest border-2 border-rose-50 rounded-2xl hover:bg-rose-50 transition-all mt-6">Sign Out</button>
        </div>
    </aside>

    <!-- NAVIGATION -->
    <nav class="fixed top-0 w-full z-50 bg-white/80 backdrop-blur-xl border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 group cursor-pointer" onclick="navigateTo('home')">
                <div class="relative flex items-center justify-center logo-box">
                    <svg width="36" height="36" viewBox="0 0 40 40" fill="none"><rect width="40" height="40" rx="10" fill="#4338ca"/><path d="M15 28V12H21.5C24.5376 12 27 14.4624 27 17.5C27 20.5376 24.5376 23 21.5 23H15" stroke="white" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <span class="text-lg font-black tracking-tighter uppercase hidden sm:block">PrepEase</span>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleDrawer()" class="p-3 hover:bg-slate-50 rounded-2xl transition-all flex items-center gap-2">
                    <span class="text-[10px] font-black uppercase text-slate-400 mr-2 tracking-widest hidden md:block">Aspirant Menu</span>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main id="app-shell" class="pt-20 min-h-screen">
        <!-- Views -->
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAh6pjj_eOmw2I6FMM63bDmwj5eIlbvZAI",
            authDomain: "prepease-app.firebaseapp.com",
            projectId: "prepease-app",
            storageBucket: "prepease-app.firebasestorage.app",
            messagingSenderId: "200948432412",
            appId: "1:200948432412:web:de0582b6437305c822a9d9",
            measurementId: "G-5673GJ545C"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'prepease-app';

        // --- STATE ---
        const state = {
            view: 'home',
            isAuthenticated: false,
            userName: '',
            userId: null,
            progress: {},
            mistakes: [],
            totalPoints: 0,
            totalCoins: 0,
            authMode: 'login',
            currentAnkiIndex: 0,
            isAnkiFlipped: false
        };

        const topicsData = {
            grammar: [
                { id: 'nouns', title: 'Nouns & Case', icon: 'üî°' },
                { id: 'tenses', title: 'Tense Mastery', icon: '‚è≥' },
                { id: 'articles', title: 'Articles', icon: 'üÖ∞Ô∏è' }
            ],
            vocabulary: [
                { id: 'synonyms', title: 'Synonyms', icon: 'üìñ' },
                { id: 'antonyms', title: 'Antonyms', icon: 'üåì' },
                { id: 'idioms', title: 'Idioms & Phrases', icon: 'üé≠' }
            ]
        };

        const quotes = [
            "Consistency is the key to Selection. üéØ",
            "Mastering English is half the battle won. üá¨üáß",
            "Focus on the mission, not the competition. ‚öîÔ∏è",
            "Your future self will thank you for this practice session. üèõÔ∏è",
            "Discipline is the bridge between goals and accomplishment. üáÆüá≥"
        ];

        // --- NAVIGATION ---
        window.toggleDrawer = () => {
            document.getElementById('drawer').classList.toggle('open');
            document.getElementById('drawer-overlay').classList.toggle('open');
        };

        window.navigateTo = (view, params = {}) => {
            const protectedViews = ['english-selection', 'topics-grid', 'levels-grid', 'content-view', 'mistakes-book', 'doubts', 'exams-pyq'];
            if (protectedViews.includes(view) && !state.isAuthenticated) {
                state.view = 'login';
            } else {
                state.view = view;
            }
            Object.assign(state, params);
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function getBaseDir() {
            const path = window.location.pathname;
            return path.substring(0, path.lastIndexOf('/') + 1) || '/';
        }

        // --- FIREBASE DATA FLOW ---
        async function loadUserData() {
            if (!auth.currentUser) return;
            state.userId = auth.currentUser.uid;

            const profileRef = doc(db, 'artifacts', appId, 'users', state.userId, 'profile', 'info');
            const profileSnap = await getDoc(profileRef);
            if (profileSnap.exists()) {
                state.userName = profileSnap.data().name;
                state.isAuthenticated = true;
                updateDrawerUI();
            }

            onSnapshot(collection(db, 'artifacts', appId, 'users', state.userId, 'progress'), (snap) => {
                state.progress = {}; state.totalPoints = 0; state.totalCoins = 0;
                snap.forEach(doc => {
                    const d = doc.data();
                    state.progress[doc.id] = d;
                    state.totalPoints += (d.points || 0);
                    state.totalCoins += (d.coins || 0);
                });
                updateDrawerUI();
                if (state.view === 'home') render();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'users', state.userId, 'mistakes'), (snap) => {
                state.mistakes = [];
                snap.forEach(doc => state.mistakes.push({ id: doc.id, ...doc.data() }));
                state.mistakes = state.mistakes.sort(() => Math.random() - 0.5);
                if (state.view === 'home' || state.view === 'mistakes-book') render();
            });
        }

        function updateDrawerUI() {
            const nameEl = document.getElementById('drawer-name');
            const avatarEl = document.getElementById('drawer-avatar');
            const fillEl = document.getElementById('drawer-progress-fill');
            const pctEl = document.getElementById('drawer-percent');
            const velocityEl = document.getElementById('drawer-velocity');

            if (state.userName) {
                nameEl.innerText = state.userName;
                avatarEl.innerText = state.userName[0].toUpperCase();
                
                const totalLevels = 10 * (topicsData.grammar.length + topicsData.vocabulary.length);
                const doneCount = Object.keys(state.progress).length;
                const percent = Math.round((doneCount / totalLevels) * 100);
                
                fillEl.style.width = `${percent}%`;
                pctEl.innerText = `${percent}%`;

                const recent = Object.values(state.progress).sort((a,b) => new Date(b.completedAt) - new Date(a.completedAt)).slice(0, 7);
                velocityEl.innerHTML = recent.map(s => `
                    <div class="flex-1 bg-indigo-600 rounded-sm" style="height: ${(s.score/s.total)*100}%"></div>
                `).join('');
            }
        }

        // --- RENDER VIEWS ---
        function render() {
            const shell = document.getElementById('app-shell');
            switch(state.view) {
                case 'home': shell.innerHTML = renderHome(); break;
                case 'login': shell.innerHTML = renderLogin(); break;
                case 'mistakes-book': shell.innerHTML = renderMistakesBook(); break;
                case 'doubts': shell.innerHTML = renderDoubts(); break;
                case 'english-selection': shell.innerHTML = renderEnglishSelection(); break;
                case 'topics-grid': shell.innerHTML = renderTopicsGrid(); break;
                case 'levels-grid': shell.innerHTML = renderLevelsGrid(); break;
                case 'exams-pyq': shell.innerHTML = renderExamsPYQ(); break;
                case 'content-view': shell.innerHTML = `<div id="content-container" class="max-w-6xl mx-auto px-6 py-20"></div>`; loadContent(); break;
            }
        }

        function renderHome() {
            const rank = (p) => p < 500 ? 'üå± Junior Aspirant' : p < 2000 ? '‚öîÔ∏è Warrior' : 'üèõÔ∏è Officer';
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            return `
                <div class="hero-gradient p-10 view-transition">
                    <div class="max-w-7xl mx-auto">
                        <div class="mb-16">
                            <h2 class="text-6xl font-black text-slate-900 tracking-tighter mb-4 leading-tight">Hello, <span class="text-indigo-600">${state.userName || 'Aspirant'}!</span></h2>
                            <p class="text-lg text-slate-400 font-medium italic">"${randomQuote}"</p>
                        </div>

                        <div class="mb-12">
                            <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Current Mastery Case</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-indigo-600 p-8 rounded-[3rem] text-white shadow-2xl shadow-indigo-100 flex flex-col justify-between">
                                    <p class="text-[10px] font-black uppercase tracking-widest opacity-60">Mastery Points</p>
                                    <p class="text-6xl font-black my-4">${state.totalPoints}</p>
                                    <div class="flex gap-4">
                                        <div class="bg-white/10 px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest">ü™ô ${state.totalCoins} Coins</div>
                                        <div class="bg-white/10 px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest">${rank(state.totalPoints)}</div>
                                    </div>
                                </div>
                                <div onclick="navigateTo('mistakes-book')" class="bg-white border-2 border-slate-50 p-8 rounded-[3rem] flex flex-col justify-between shadow-sm hover:shadow-xl transition-all cursor-pointer">
                                    <p class="text-[10px] font-black uppercase tracking-widest text-rose-400">Mistakes Book</p>
                                    <p class="text-6xl font-black my-4 text-slate-900">${state.mistakes.length}</p>
                                    <span class="text-rose-500 text-xs font-bold uppercase tracking-widest">Anki Session ‚ûú</span>
                                </div>
                                <div onclick="navigateTo('doubts')" class="bg-emerald-50 border-2 border-emerald-100 p-8 rounded-[3rem] flex flex-col justify-between shadow-sm hover:shadow-xl transition-all cursor-pointer">
                                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-600">Mentor Sync</p>
                                    <p class="text-xs font-bold text-emerald-800 my-4 leading-relaxed">Direct path to mentor logic for all selection exam doubts.</p>
                                    <span class="text-emerald-600 text-xs font-bold uppercase tracking-widest underline">Ask mentor ‚ûú</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-20">
                            <div onclick="navigateTo('english-selection')" class="premium-card group">
                                <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-all">üá¨üáß</div>
                                <h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">General English</h3>
                                <p class="text-slate-500 text-xs leading-relaxed">Levels 1-10 complete roadmap.</p>
                            </div>
                            <div onclick="navigateTo('mistakes-book')" class="premium-card group border-rose-50">
                                <div class="w-14 h-14 bg-rose-50 text-rose-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-rose-600 group-hover:text-white transition-all">üìì</div>
                                <h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">Anki Deck</h3>
                                <p class="text-slate-500 text-xs leading-relaxed">Spaced repetition revision.</p>
                            </div>
                            <div onclick="navigateTo('exams-pyq', { currentCategory: 'karnataka' })" class="premium-card group border-emerald-50">
                                <div class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-emerald-600 group-hover:text-white transition-all">üèõÔ∏è</div>
                                <h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">KPSC Selection</h3>
                                <p class="text-slate-500 text-xs leading-relaxed">FDA, SDA archives.</p>
                            </div>
                            <div onclick="navigateTo('exams-pyq', { currentCategory: 'ssc' })" class="premium-card group border-amber-50">
                                <div class="w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-amber-600 group-hover:text-white transition-all">‚öîÔ∏è</div>
                                <h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">SSC Hub</h3>
                                <p class="text-slate-500 text-xs leading-relaxed">CGL, CHSL roadmap.</p>
                            </div>
                        </div>

                        <!-- Footer Links as requested -->
                        <div class="pt-20 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-10">
                            <div class="text-left">
                                <h4 class="text-2xl font-black text-slate-900 mb-2 tracking-tighter uppercase">PrepEase Mastery</h4>
                                <p class="text-slate-400 text-sm">Automated Selection Roadmap 2026</p>
                            </div>
                            <div class="flex gap-8 items-center">
                                <a href="https://t.me/prepeaseengl" target="_blank" class="px-6 py-3 bg-indigo-50 text-indigo-600 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all flex items-center gap-2">
                                    <span>üì¢</span> Join Telegram
                                </a>
                                <button onclick="navigateTo('doubts')" class="px-6 py-3 bg-emerald-50 text-emerald-600 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-emerald-600 hover:text-white transition-all flex items-center gap-2">
                                    <span>üí¨</span> Ask Doubt
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- ANKI MISTAKES LOGIC (Requirement: Challenge with 4 Options) ---
        function renderMistakesBook() {
            if (state.mistakes.length === 0) {
                return `<div class="max-w-xl mx-auto py-40 text-center view-transition">
                    <div class="text-6xl mb-6 text-indigo-600">üíé</div>
                    <h3 class="text-2xl font-black text-slate-900 mb-2 text-bold">All Errors Cleared</h3>
                    <p class="text-slate-500 mb-10">You have no active mistakes. Precision is 100%.</p>
                    <button onclick="navigateTo('home')" class="px-10 py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-xl">Dashboard</button>
                </div>`;
            }

            const current = state.mistakes[state.currentAnkiIndex];
            const flippedClass = state.isAnkiFlipped ? 'flipped' : '';
            // Requirement: Give 4 options in Anki like a test
            const options = current.options || ['Loading...', '...', '...', '...'];

            return `
                <div class="max-w-3xl mx-auto py-20 px-6 view-transition">
                    <div class="flex justify-between items-center mb-10">
                        <h2 class="text-xl font-black text-slate-900 uppercase tracking-widest">Mastery Anki Deck</h2>
                        <span class="text-[10px] font-black bg-slate-900 text-white px-3 py-1 rounded-full">${state.currentAnkiIndex + 1} / ${state.mistakes.length}</span>
                    </div>

                    <div class="anki-card ${flippedClass}">
                        <div class="anki-card-inner">
                            <!-- FRONT -->
                            <div class="anki-front">
                                <span class="px-3 py-1 bg-rose-50 text-rose-600 rounded-full text-[9px] font-black uppercase mb-6 border border-rose-100">Mistake Challenge</span>
                                <h3 class="text-2xl font-bold text-slate-900 leading-relaxed mb-10">"${current.question}"</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full">
                                    ${options.map(o => `
                                        <button onclick="resolveAnki('${o.trim()}', '${current.answer.trim()}')" 
                                                class="w-full py-4 px-6 border-2 border-slate-50 bg-slate-50/50 rounded-[2rem] text-sm font-bold text-slate-600 hover:border-indigo-600 hover:bg-white transition-all text-left">
                                            ${o}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <!-- BACK -->
                            <div class="anki-back">
                                <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-6">Correction Logic</p>
                                <div class="bg-white/60 p-6 rounded-[2.5rem] mb-6 w-full border border-indigo-100">
                                    <p class="text-xs font-black text-emerald-600 uppercase mb-2">Mastery Answer</p>
                                    <p class="text-2xl font-bold text-slate-900 font-kannada leading-tight">${current.answer}</p>
                                </div>
                                <p class="text-sm text-indigo-900 font-medium leading-relaxed italic">"${current.explanation || 'Review the curriculum cards for mapping context.'}"</p>
                                
                                <button onclick="nextAnki()" class="mt-10 px-10 py-4 bg-indigo-600 text-white font-black rounded-2xl text-[10px] uppercase shadow-lg shadow-indigo-200">Continue Training ‚ûú</button>
                                <p class="mt-4 text-[9px] font-black text-slate-400 uppercase tracking-widest">Mastery Count: ${current.masteryCount || 0}/5</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-center mt-12 text-slate-400 text-[10px] font-black uppercase tracking-widest">Answer correctly 5 times to remove from book</p>
                </div>`;
        }

        window.resolveAnki = async (selected, correct) => {
            const current = state.mistakes[state.currentAnkiIndex];
            const mRef = doc(db, 'artifacts', appId, 'users', state.userId, 'mistakes', current.id);
            const isCorrect = selected === correct;
            
            if (isCorrect) {
                const count = (current.masteryCount || 0) + 1;
                if (count >= 5) await deleteDoc(mRef);
                else await updateDoc(mRef, { masteryCount: count });
            } else {
                await updateDoc(mRef, { masteryCount: 0 });
            }
            state.isAnkiFlipped = true;
            render();
        };

        window.nextAnki = () => {
            state.isAnkiFlipped = false;
            state.currentAnkiIndex = (state.currentAnkiIndex + 1) % state.mistakes.length;
            render();
        };

        // --- CONTACT HUB ---
        function renderDoubts() {
            return `
                <div class="max-w-4xl mx-auto py-24 px-6 text-center view-transition">
                    <div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-[2.5rem] flex items-center justify-center text-4xl mx-auto mb-10 shadow-lg shadow-emerald-100 font-bold">üí¨</div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-4 leading-tight">Mastery Doubt Sync</h2>
                    <p class="text-slate-500 mb-16 max-w-xl mx-auto font-medium leading-relaxed">Direct 1-on-1 logic mentor access. Submit your study doubt below and start your WhatsApp sync.</p>
                    
                    <div class="bg-white border border-slate-100 p-10 rounded-[4rem] shadow-sm max-w-2xl mx-auto text-left relative overflow-hidden">
                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">New Support Request</h4>
                        <textarea id="query-text" placeholder="Specify the question or rule mapping you are struggling with..." class="w-full h-40 bg-slate-50 border-2 border-slate-50 p-8 rounded-[2rem] font-medium mb-8 resize-none focus:bg-white transition-all"></textarea>
                        <button onclick="askDoubtOnWA()" class="w-full py-6 bg-emerald-600 text-white font-black rounded-3xl shadow-xl uppercase tracking-widest text-[11px] hover:bg-emerald-700 transition-all active:scale-95">Synchronize DOUBT via WhatsApp</button>
                    </div>

                    <button onclick="navigateTo('home')" class="mt-20 py-5 px-10 bg-slate-900 text-white font-black rounded-[2rem] hover:bg-slate-800 transition-all uppercase tracking-widest text-[10px]">Return to Mission Hub</button>
                </div>`;
        }

        window.askDoubtOnWA = function() {
            const input = document.getElementById('query-text');
            const userMsg = input.value.trim();
            const name = state.userName || 'Aspirant';
            const text = encodeURIComponent(`PrepEase Support Portal\nAspirant: ${name}\n\nDoubt: ${userMsg || "I need help with English logic..."}`);
            window.open(`https://wa.me/918088165696?text=${text}`, '_blank');
            input.value = '';
        };

        // --- AUTH ---
        function renderLogin() {
            const isLogin = state.authMode === 'login';
            return `<div class="max-w-md mx-auto py-32 px-6 view-transition">
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-2 text-center leading-tight">${isLogin ? 'Mission Login' : 'Enroll Academy'}</h2>
                <form id="login-form" class="bg-white border border-slate-200 p-10 rounded-[3rem] shadow-sm">
                    ${!isLogin ? `<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Display Name</label><input id="name-input" type="text" placeholder="Full Name" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-6 focus:bg-white transition-all" required>` : ''}
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Username ID</label><input id="username-input" type="text" placeholder="aspirant_01" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-6 focus:bg-white transition-all" required>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Mastery Password</label><input id="password-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-10 focus:bg-white transition-all" required>
                    <button type="submit" id="login-btn" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl uppercase text-xs active:scale-95 transition-all">Enter hub</button>
                    <button type="button" onclick="state.authMode = '${isLogin ? 'signup' : 'login'}'; render();" class="mt-8 w-full text-indigo-600 font-bold text-xs hover:underline">${isLogin ? "New Aspirant? Create ID" : "Already have ID? Log In"}</button>
                </form>
            </div>`;
        }

        async function handleLogin(e) {
            e.preventDefault();
            const userIn = document.getElementById('username-input').value;
            const passIn = document.getElementById('password-input').value;
            const isSignUp = state.authMode === 'signup';
            const email = `${userIn.toLowerCase()}@prepease.internal`;
            try {
                if (isSignUp) {
                    const name = document.getElementById('name-input').value;
                    const res = await createUserWithEmailAndPassword(auth, email, passIn);
                    await setDoc(doc(db, 'artifacts', appId, 'users', res.user.uid, 'profile', 'info'), { name, joinedAt: new Date().toISOString() });
                } else { await signInWithEmailAndPassword(auth, email, passIn); }
                navigateTo('home');
            } catch (e) { alert("Auth Denied."); }
        }

        window.handleLogout = async () => { await signOut(auth); state.isAuthenticated = false; navigateTo('home'); };

        // --- CONTENT LOGIC ---
        function renderEnglishSelection() {
            return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                <button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Dashboard</button>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-12">English <span class="text-indigo-600">Track</span></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 text-left">
                    <div onclick="navigateTo('topics-grid', { currentType: 'grammar' })" class="premium-card group">
                        <span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-[9px] font-black rounded-full uppercase tracking-widest mb-6 inline-block border border-indigo-100">Foundational Rules</span>
                        <h3 class="text-3xl font-black mb-4 tracking-tight">English Grammar</h3>
                        <p class="text-slate-500 mb-8 leading-relaxed">Systematic mastery of grammatical foundations for SSC & KPSC.</p>
                        <span class="text-indigo-600 font-bold text-sm uppercase tracking-widest">Open Units ‚ûú</span>
                    </div>
                    <div onclick="navigateTo('topics-grid', { currentType: 'vocabulary' })" class="premium-card group border-emerald-50">
                        <span class="px-3 py-1 bg-emerald-50 text-emerald-700 text-[9px] font-black rounded-full uppercase tracking-widest mb-6 inline-block border border-emerald-100">Bilingual Recall</span>
                        <h3 class="text-3xl font-black mb-4 tracking-tight">Vocabulary Hub</h3>
                        <p class="text-slate-500 mb-8 leading-relaxed">Bilingual mappings for high-frequency synonyms and idioms.</p>
                        <span class="text-emerald-600 font-bold text-sm uppercase tracking-widest">Open Units ‚ûú</span>
                    </div>
                </div>
            </div>`;
        }

        function renderTopicsGrid() {
            const topics = topicsData[state.currentType];
            return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                <button onclick="navigateTo('english-selection')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Category</button>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter capitalize mb-12">${state.currentType} Mastery</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
                    ${topics.map(t => `
                        <div onclick="navigateTo('levels-grid', { currentTopic: '${t.id}', currentTopicTitle: '${t.title}' })" class="premium-card p-10 group">
                            <div class="text-5xl mb-8 group-hover:scale-125 transition-all duration-500">${t.icon}</div>
                            <h3 class="text-xl font-bold text-slate-900 mb-4 tracking-tight font-bold font-bold">${t.title}</h3>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Lv 1-10 Active</p>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        function renderLevelsGrid() {
            return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                <button onclick="navigateTo('topics-grid')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Back</button>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-16">${state.currentTopicTitle} Phases</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                    ${Array.from({length: 10}, (_, i) => i + 1).map(lv => {
                        const progressId = `${state.currentType}_${state.currentTopic}_${lv}`;
                        const isDone = state.progress[progressId];
                        return `<div onclick="navigateTo('content-view', { currentLevel: ${lv} })" 
                            class="p-10 border-2 ${isDone ? 'border-emerald-500 bg-emerald-50/30' : 'border-slate-100 bg-white'} rounded-[3rem] text-center hover:border-indigo-600 transition-all cursor-pointer group shadow-sm relative">
                            ${isDone ? `<span class="absolute top-4 right-4 text-emerald-600 text-[8px] font-black bg-emerald-100 px-2 py-0.5 rounded-full uppercase">DONE</span>` : ''}
                            <span class="text-4xl font-black text-slate-900">${lv}</span>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderExamsPYQ() {
            return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                <button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Dashboard</button>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-12 capitalize">${state.currentCategory} Regional Hub</h2>
                <div class="bg-white border border-slate-100 p-20 rounded-[4rem] text-center shadow-sm">
                    <div class="text-6xl mb-6 text-slate-200">üìÇ</div>
                    <p class="text-slate-400 font-black uppercase tracking-widest text-xs italic">Archives for ${state.currentCategory} coming soon in Q2 2026.</p>
                </div>
            </div>`;
        }

        window.loadContent = async () => {
            const container = document.getElementById('content-container');
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const url = new URL(`content/general-english/${type}/${topic}/level-${level}.json`, window.location.origin + getBaseDir()).href;
            container.innerHTML = `<div class="py-20 text-center animate-pulse text-slate-400 font-black uppercase text-xs">Opening Case File...</div>`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                renderCards(data);
            } catch (e) {
                container.innerHTML = `<div class="text-center p-20 bg-white rounded-[3rem] border border-slate-100"><div class="text-5xl mb-6 text-slate-200">üìÅ</div><h3 class="font-bold text-xl mb-4">Phase Offline</h3><code class="text-[10px] bg-slate-50 p-2 rounded block break-all text-indigo-600 mb-6 font-bold">${url}</code><button onclick="navigateTo('levels-grid')" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-2xl uppercase text-[10px]">Back to grid</button></div>`;
            }
        };

        function renderCards(data) {
            const container = document.getElementById('content-container');
            container.innerHTML = `
                <div class="mb-12 text-center lg:text-left">
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter">Phase ${state.currentLevel} <span class="text-indigo-600">Mastery Cards</span></h2>
                    <p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mt-4 leading-relaxed italic">"Repetition is the mother of learning." Try to recall Kannada meaning before revealing.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${data.map((item, i) => `
                        <div class="bg-white p-10 rounded-[3.5rem] border-2 border-slate-50 hover:border-indigo-100 transition-all text-center group shadow-sm">
                            <div class="text-5xl mb-8 group-hover:scale-110 transition-transform">${item.emoji || 'üìó'}</div>
                            <h3 class="text-3xl font-black text-slate-900 tracking-tighter mb-8 font-bold">${item.word}</h3>
                            <div class="pt-6 border-t border-slate-50">
                                <p class="text-2xl font-bold text-slate-800 font-kannada leading-tight">${item.meaning_kannada}</p>
                                <p class="text-sm text-slate-400 mt-3 font-medium leading-relaxed italic">${item.meaning_english}</p>
                            </div>
                        </div>
                    `).join('')}
                    <div class="col-span-full mt-10"><button onclick="loadQuiz()" class="w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-2xl uppercase text-xs tracking-widest active:scale-95 transition-all">Start Assessment Phase</button></div>
                </div>`;
        }

        window.loadQuiz = async () => {
            const container = document.getElementById('content-container');
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const url = new URL(`content/general-english/${type}/${topic}/level${level}-test.json`, window.location.origin + getBaseDir()).href;
            try {
                const res = await fetch(url);
                const questions = await res.json();
                renderQuiz(questions);
            } catch (e) { alert("Test file missing."); }
        };

        function renderQuiz(questions) {
            const container = document.getElementById('content-container');
            container.innerHTML = `<h2 class="text-3xl font-black mb-10">Case Analysis Phase</h2><div id="quiz-list" class="space-y-6"></div>`;
            const list = document.getElementById('quiz-list');
            questions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = "bg-white p-10 rounded-[3.5rem] border-2 border-slate-100 shadow-sm";
                div.innerHTML = `<p class="text-lg font-bold mb-8">#${i+1} ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${q.options.map(o => `<label class="flex items-center gap-4 px-8 py-5 border-2 border-slate-50 rounded-[2rem] cursor-pointer hover:bg-slate-50 has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50 transition-all"><input type="radio" name="q${i}" value="${o}" class="accent-indigo-600 w-5 h-5"><span>${o}</span></label>`).join('')}</div>`;
                list.appendChild(div);
            });
            const btn = document.createElement('button');
            btn.className = "w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-xl uppercase mt-8";
            btn.innerText = "Synchronize Results";
            btn.onclick = () => submitTest(questions);
            list.appendChild(btn);
        }

        async function submitTest(questions) {
            let score = 0, wrong = 0, mistakes = [];
            questions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                if (sel && sel.value.trim() === q.answer.trim()) score++;
                else { 
                    wrong++; 
                    mistakes.push({ 
                        question: q.question, 
                        answer: q.answer, 
                        options: q.options, // Save options for Anki challenge
                        explanation: q.explanation, 
                        userAnswer: sel ? sel.value : 'No selection' 
                    });
                }
            });
            const points = score * 10, coins = score - Math.floor(wrong/4);
            await saveResultToCloud(score, questions.length, points, coins, mistakes);
            navigateTo('home');
        }

        async function saveResultToCloud(score, total, points, coins, mistakes) {
            if (!auth.currentUser) return;
            const progressId = `${state.currentType}_${state.currentTopic}_${state.currentLevel}`;
            await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'progress', progressId), { score, total, points, coins, completedAt: new Date().toISOString(), type: state.currentType, topic: state.currentTopic, level: state.currentLevel });
            for (const m of mistakes) {
                const mId = btoa(m.question).substring(0, 20);
                await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'mistakes', mId), { ...m, type: state.currentType, topic: state.currentTopic, level: state.currentLevel, masteryCount: 0 });
            }
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', state.userId), { name: state.userName, points: state.totalPoints + points, lastActive: new Date().toISOString() }, { merge: true });
        }

        onAuthStateChanged(auth, (user) => { if (user) loadUserData(); else { state.isAuthenticated = false; render(); } });
        document.addEventListener('DOMContentLoaded', () => { render(); document.addEventListener('submit', (e) => { if (e.target.id === 'login-form') handleLogin(e); }); });
        let qi = 0; setInterval(() => { const el = document.getElementById('moto-text'); if (!el) return; qi = (qi + 1) % quotes.length; el.innerText = quotes[qi]; }, 5000);
    </script>
</body>
</html>
