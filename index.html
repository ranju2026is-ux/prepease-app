<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrepEase | Karnataka & SSC Mastery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { scroll-behavior: smooth; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a; 
            overflow-x: hidden; 
        }
        
        .hero-gradient {
            background: radial-gradient(circle at 100% 0%, rgba(67, 56, 202, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 0% 100%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            background-color: #ffffff;
        }

        /* TOP FLOATING QUOTE BAR - Explicit Centering */
        .quote-bar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 70;
            background-color: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            color: white;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .quote-text {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            text-align: center;
            width: 100%;
        }

        .premium-card {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 2.5rem;
            padding: 2rem;
            transition: all 0.5s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px -2px rgba(15, 23, 42, 0.03);
        }

        .premium-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 30px -10px rgba(67, 56, 202, 0.12);
            border-color: rgba(67, 56, 202, 0.3);
        }

        /* ANKI CARD Challenge STYLES */
        .anki-card {
            perspective: 1000px;
            height: 580px;
            width: 100%;
        }
        .anki-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .anki-card.flipped .anki-card-inner {
            transform: rotateY(180deg);
        }
        .anki-front, .anki-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 3.5rem;
            border-width: 2px;
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .anki-front { 
            border-color: #f1f5f9;
            background-color: white;
            box-shadow: 0 20px 25px -5px rgba(241, 245, 249, 0.5);
        }
        .anki-back { 
            border-color: #e0e7ff;
            background-color: #eef2ff;
            box-shadow: 0 25px 50px -12px rgba(224, 231, 255, 0.5);
            transform: rotateY(180deg);
        }

        .font-kannada { line-height: 1.6; }
        
        @keyframes box-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .logo-box { animation: box-pulse 4s ease-in-out infinite; }

        .view-transition { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* WORD WRAP FIX */
        .break-word-custom {
            overflow-wrap: anywhere;
            word-break: break-word;
            hyphens: auto;
        }
    </style>
</head>
<body>

    <!-- CENTERED FLOATING MOTIVATION BAR -->
    <div class="quote-bar">
        <span id="floating-quote" class="quote-text">Stay Disciplined. Excellence is a daily habit. üéØ</span>
    </div>

    <!-- MINIMALIST TOP NAV -->
    <nav class="fixed top-10 w-full z-50 bg-white/80 backdrop-blur-xl border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 group cursor-pointer" onclick="navigateTo('home')">
                <div class="relative flex items-center justify-center logo-box">
                    <svg width="36" height="36" viewBox="0 0 40 40" fill="none"><rect width="40" height="40" rx="10" fill="#4338ca"/><path d="M15 28V12H21.5C24.5376 12 27 14.4624 27 17.5C27 20.5376 24.5376 23 21.5 23H15" stroke="white" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <span class="text-xl font-black tracking-tighter uppercase">PrepEase</span>
            </div>
            
            <div id="auth-header-btn"></div>
        </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main id="app-shell" class="pt-[120px] min-h-screen">
        <!-- Content loads here -->
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAh6pjj_eOmw2I6FMM63bDmwj5eIlbvZAI",
            authDomain: "prepease-app.firebaseapp.com",
            projectId: "prepease-app",
            storageBucket: "prepease-app.firebasestorage.app",
            messagingSenderId: "200948432412",
            appId: "1:200948432412:web:de0582b6437305c822a9d9",
            measurementId: "G-5673GJ545C"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'prepease-app';

        // --- DATA & STATE ---
        const quotes = [
            "Consistency is the key to Selection. üéØ",
            "Mastering English is half the battle won. üá¨üáß",
            "Focus on the mission, not the competition. ‚öîÔ∏è",
            "Your future self will thank you for this practice session. üèõÔ∏è",
            "Discipline is the bridge between goals and accomplishment. üáÆüá≥"
        ];

        const floatingQuotes = [
            "Believe in your potential. Excellence is a habit. üéØ",
            "Mistakes are lessons in disguise. üìö",
            "Aspirant to Officer: Keep moving. üèõÔ∏è",
            "Persistence beats resistance. ‚ö°",
            "Precision is the path to success. üíé",
            "Believe. Practice. Succeed. üèÜ"
        ];

        const state = {
            view: 'home',
            isAuthenticated: false,
            userName: '',
            userId: null,
            progress: {},
            mistakes: [],
            totalPoints: 0,
            totalCoins: 0,
            authMode: 'login',
            currentAnkiIndex: 0,
            isAnkiFlipped: false
        };

        const topicsData = {
            grammar: [
                { id: 'nouns', title: 'Nouns & Case', icon: 'üî°' },
                { id: 'tenses', title: 'Tense Mastery', icon: '‚è≥' },
                { id: 'articles', title: 'Articles', icon: 'üÖ∞Ô∏è' }
            ],
            vocabulary: [
                { id: 'synonyms', title: 'Synonyms', icon: 'üìñ' },
                { id: 'antonyms', title: 'Antonyms', icon: 'üåì' },
                { id: 'idioms', title: 'Idioms & Phrases', icon: 'üé≠' }
            ]
        };

        // --- GLOBAL WRAPPERS ---
        window.navigateTo = (view, params = {}) => {
            const protectedViews = ['english-selection', 'topics-grid', 'levels-grid', 'content-view', 'mistakes-book', 'doubts', 'exams-pyq'];
            if (protectedViews.includes(view) && !state.isAuthenticated) {
                state.view = 'login';
            } else {
                state.view = view;
            }
            Object.assign(state, params);
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.handleLogout = async () => { 
            await signOut(auth); 
            state.isAuthenticated = false; 
            state.userName = '';
            state.userId = null;
            navigateTo('home'); 
        };

        async function handleLogin(e) {
            e.preventDefault();
            const userIn = document.getElementById('username-input').value;
            const passIn = document.getElementById('password-input').value;
            const isSignUp = state.authMode === 'signup';
            const email = `${userIn.toLowerCase()}@prepease.internal`;
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = "Authorizing...";

            try {
                if (isSignUp) {
                    const name = document.getElementById('name-input').value;
                    const res = await createUserWithEmailAndPassword(auth, email, passIn);
                    await setDoc(doc(db, 'artifacts', appId, 'users', res.user.uid, 'profile', 'info'), { name, joinedAt: new Date().toISOString() });
                } else {
                    await signInWithEmailAndPassword(auth, email, passIn);
                }
                navigateTo('home');
            } catch (e) { 
                alert("Access Denied: Check Username/Password."); 
                btn.disabled = false;
                btn.innerText = isSignUp ? "Enroll Now" : "Authorize";
            }
        }

        function getBaseDir() {
            const path = window.location.pathname;
            return path.substring(0, path.lastIndexOf('/') + 1) || '/';
        }

        async function loadUserData() {
            if (!auth.currentUser) return;
            state.userId = auth.currentUser.uid;

            const profileRef = doc(db, 'artifacts', appId, 'users', state.userId, 'profile', 'info');
            const profileSnap = await getDoc(profileRef);
            if (profileSnap.exists()) {
                state.userName = profileSnap.data().name;
                state.isAuthenticated = true;
                render();
            }

            onSnapshot(collection(db, 'artifacts', appId, 'users', state.userId, 'progress'), (snap) => {
                state.progress = {}; state.totalPoints = 0; state.totalCoins = 0;
                snap.forEach(doc => {
                    const d = doc.data();
                    state.progress[doc.id] = d;
                    state.totalPoints += (d.points || 0);
                    state.totalCoins += (d.coins || 0);
                });
                if (state.view === 'home') render();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'users', state.userId, 'mistakes'), (snap) => {
                state.mistakes = [];
                snap.forEach(doc => state.mistakes.push({ id: doc.id, ...doc.data() }));
                state.mistakes = state.mistakes.sort(() => Math.random() - 0.5);
                if (state.view === 'home' || state.view === 'mistakes-book') render();
            });
        }

        // --- RENDER VIEWS ---
        function render() {
            const shell = document.getElementById('app-shell');
            const authBtn = document.getElementById('auth-header-btn');

            if (state.isAuthenticated) {
                authBtn.innerHTML = `<button onclick="handleLogout()" class="text-[10px] font-black uppercase tracking-widest text-rose-500 px-4 py-2 hover:bg-rose-50 rounded-xl transition-all">Sign Out</button>`;
            } else {
                authBtn.innerHTML = `<button onclick="navigateTo('login')" class="text-[10px] font-black uppercase tracking-widest text-indigo-600 px-4 py-2 hover:bg-indigo-50 rounded-xl transition-all">Login</button>`;
            }

            if (!state.isAuthenticated && state.view !== 'login') {
                state.view = 'login';
            }

            switch(state.view) {
                case 'home': shell.innerHTML = renderHome(); break;
                case 'login': shell.innerHTML = renderLogin(); break;
                case 'mistakes-book': shell.innerHTML = renderMistakesBook(); break;
                case 'doubts': shell.innerHTML = renderDoubts(); break;
                case 'english-selection': shell.innerHTML = renderEnglishSelection(); break;
                case 'topics-grid': shell.innerHTML = renderTopicsGrid(); break;
                case 'levels-grid': shell.innerHTML = renderLevelsGrid(); break;
                case 'exams-pyq': shell.innerHTML = renderExamsPYQ(); break;
                case 'content-view': shell.innerHTML = `<div id="content-container" class="max-w-6xl mx-auto px-6 py-20"></div>`; loadContent(); break;
            }
        }

        function renderHome() {
            const rank = (p) => p < 500 ? 'üå± Junior Aspirant' : p < 2000 ? '‚öîÔ∏è Warrior' : 'üèõÔ∏è Officer';
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            return `
                <div class="hero-gradient p-10 view-transition">
                    <div class="max-w-7xl mx-auto">
                        <div class="mb-12">
                            <h2 class="text-6xl font-black text-slate-900 tracking-tighter mb-4 leading-tight">Hello, <span class="text-indigo-600">${state.userName || 'Aspirant'}!</span></h2>
                            <p class="text-lg text-slate-400 font-medium italic">"${randomQuote}"</p>
                        </div>

                        <div class="mb-12">
                            <div class="bg-indigo-600 p-12 rounded-[3.5rem] text-white shadow-2xl shadow-indigo-200 flex flex-col md:flex-row justify-between items-center gap-8">
                                <div class="text-center md:text-left">
                                    <p class="text-[10px] font-black uppercase tracking-widest opacity-60 mb-2">Total Progress</p>
                                    <p class="text-7xl font-black leading-none">${state.totalPoints}</p>
                                    <p class="text-sm font-bold opacity-80 mt-2 uppercase tracking-tighter">Mastery Points</p>
                                </div>
                                <div class="flex gap-6">
                                    <div class="bg-white/10 p-6 rounded-3xl text-center border border-white/5">
                                        <p class="text-2xl font-black">ü™ô ${state.totalCoins}</p>
                                        <p class="text-[9px] font-black uppercase opacity-60 mt-1">Coins</p>
                                    </div>
                                    <div class="bg-white/10 p-6 rounded-3xl text-center border border-white/5">
                                        <p class="text-2xl font-black">${rank(state.totalPoints).split(' ')[1]}</p>
                                        <p class="text-[9px] font-black uppercase opacity-60 mt-1">Rank</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-16">
                            <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-8">Curriculum Units</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div onclick="navigateTo('english-selection')" class="premium-card group">
                                    <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-all">üá¨üáß</div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2">General English</h3>
                                    <p class="text-slate-500 text-xs leading-relaxed">Levels 1-10 complete roadmap for selection exams.</p>
                                </div>
                                <div onclick="navigateTo('exams-pyq', { currentCategory: 'karnataka' })" class="premium-card group">
                                    <div class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-emerald-600 group-hover:text-white transition-all">üèõÔ∏è</div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2">KPSC Hub</h3>
                                    <p class="text-slate-500 text-xs leading-relaxed">Archives and blueprints.</p>
                                </div>
                                <div onclick="navigateTo('exams-pyq', { currentCategory: 'ssc' })" class="premium-card group">
                                    <div class="w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-amber-600 group-hover:text-white transition-all">‚öîÔ∏è</div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2">SSC Central</h3>
                                    <p class="text-slate-500 text-xs leading-relaxed">CGL, CHSL focus bank.</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                            <div onclick="navigateTo('mistakes-book')" class="bg-white border-2 border-rose-100 p-10 rounded-[3.5rem] shadow-sm hover:shadow-xl transition-all cursor-pointer group flex items-center justify-between">
                                <div>
                                    <p class="text-[10px] font-black uppercase tracking-widest text-rose-400 mb-1">Retention Lab</p>
                                    <h3 class="text-2xl font-bold text-slate-900">Mistakes Book</h3>
                                    <p class="text-slate-500 text-xs mt-2">${state.mistakes.length} errors found in deck.</p>
                                </div>
                                <div class="w-16 h-16 bg-rose-50 text-rose-600 rounded-3xl flex items-center justify-center text-3xl group-hover:bg-rose-600 group-hover:text-white transition-all">üìì</div>
                            </div>
                            
                            <div onclick="navigateTo('doubts')" class="bg-white border-2 border-emerald-100 p-10 rounded-[3.5rem] shadow-sm hover:shadow-xl transition-all cursor-pointer group flex items-center justify-between">
                                <div>
                                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-500 mb-1">Private Support</p>
                                    <h3 class="text-2xl font-bold text-slate-900">Support Hub</h3>
                                    <p class="text-slate-500 text-xs mt-2">Direct mentor logic chat.</p>
                                </div>
                                <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-3xl flex items-center justify-center text-3xl group-hover:bg-emerald-600 group-hover:text-white transition-all">üí¨</div>
                            </div>
                        </div>

                        <div class="pt-10 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6 text-center">
                            <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">¬© 2026 PrepEase Mastery Hub</p>
                            <a href="https://t.me/prepeaseengl" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                                <span class="p-1 bg-indigo-50 rounded-lg">üì¢</span> Telegram Hub
                            </a>
                        </div>
                    </div>
                </div>`;
        }

        function renderMistakesBook() {
            if (state.mistakes.length === 0) {
                return `<div class="max-w-xl mx-auto py-40 text-center view-transition">
                    <div class="text-6xl mb-6 text-indigo-600">üíé</div>
                    <h3 class="text-2xl font-black text-slate-900 mb-2 uppercase tracking-tight">Accuracy: 100%</h3>
                    <p class="text-slate-400 uppercase text-xs tracking-widest mb-10">No active mistakes to resolve.</p>
                    <button onclick="navigateTo('home')" class="px-12 py-5 bg-indigo-600 text-white font-black rounded-3xl shadow-xl uppercase text-xs">Return Dashboard</button>
                </div>`;
            }

            const current = state.mistakes[state.currentAnkiIndex];
            const flippedClass = state.isAnkiFlipped ? 'flipped' : '';
            const options = current.options || ['Loading...', '...', '...', '...'];

            return `
                <div class="max-w-3xl mx-auto py-20 px-6 view-transition">
                    <div class="flex justify-between items-center mb-10">
                        <h2 class="text-xl font-black text-slate-900 uppercase tracking-widest">Mastery Anki</h2>
                        <span class="text-[10px] font-black bg-slate-900 text-white px-4 py-1.5 rounded-full">${state.currentAnkiIndex + 1} / ${state.mistakes.length}</span>
                    </div>

                    <div class="anki-card ${flippedClass}">
                        <div class="anki-card-inner">
                            <div class="anki-front">
                                <span class="px-4 py-1.5 bg-rose-50 text-rose-600 rounded-full text-[9px] font-black uppercase mb-8 border border-rose-100">Recall Case</span>
                                <h3 class="text-2xl font-bold text-slate-900 leading-relaxed mb-10 italic break-word-custom">"${current.question}"</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full">
                                    ${options.map(o => `
                                        <button onclick="resolveAnki('${o.trim()}', '${current.answer.trim()}')" 
                                                class="w-full py-4 px-6 border-2 border-slate-50 bg-slate-50/50 rounded-[2rem] text-sm font-bold text-slate-600 hover:border-indigo-600 hover:bg-white transition-all text-left break-word-custom">
                                            ${o}
                                        </button>
                                    `).join('')}
                                </div>
                                <p class="mt-8 text-slate-300 text-[10px] font-black uppercase tracking-widest">Select logic to flip</p>
                            </div>
                            <div class="anki-back">
                                <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-6">Mentor Analysis</p>
                                <div class="bg-white/60 p-8 rounded-[2.5rem] mb-6 w-full border border-indigo-100">
                                    <p class="text-[10px] font-black text-emerald-600 uppercase mb-2">Target Answer</p>
                                    <p class="text-2xl font-bold text-slate-900 font-kannada leading-tight break-word-custom">${current.answer}</p>
                                </div>
                                <p class="text-sm text-indigo-900 font-medium leading-relaxed italic break-word-custom">"${current.explanation || 'Master this logic to build precision.'}"</p>
                                <button onclick="nextAnki()" class="mt-10 px-12 py-5 bg-indigo-600 text-white font-black rounded-3xl text-[10px] uppercase shadow-lg shadow-indigo-200">Next Case ‚ûú</button>
                                <p class="mt-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">Mastery: ${current.masteryCount || 0}/5</p>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        window.resolveAnki = async (selected, correct) => {
            const current = state.mistakes[state.currentAnkiIndex];
            const mRef = doc(db, 'artifacts', appId, 'users', state.userId, 'mistakes', current.id);
            if (selected === correct) {
                const count = (current.masteryCount || 0) + 1;
                if (count >= 5) await deleteDoc(mRef);
                else await updateDoc(mRef, { masteryCount: count });
            } else {
                await updateDoc(mRef, { masteryCount: 0 });
            }
            state.isAnkiFlipped = true; render();
        };

        window.nextAnki = () => { state.isAnkiFlipped = false; state.currentAnkiIndex = (state.currentAnkiIndex + 1) % state.mistakes.length; render(); };

        window.loadContent = async () => {
            const container = document.getElementById('content-container');
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const url = new URL(`content/general-english/${type}/${topic}/level-${level}.json`, window.location.origin + getBaseDir()).href;
            container.innerHTML = `<div class="py-20 text-center animate-pulse text-slate-400 font-black uppercase text-xs">Opening Case...</div>`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                renderCards(data);
            } catch (e) {
                container.innerHTML = `<div class="text-center p-20 bg-white rounded-[3rem] border border-slate-100"><div class="text-5xl mb-6 text-slate-200">üìÅ</div><h3 class="font-bold text-xl mb-4">Phase Offline</h3><button onclick="navigateTo('levels-grid')" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-2xl uppercase text-[10px]">Back to grid</button></div>`;
            }
        };

        function renderCards(data) {
            const container = document.getElementById('content-container');
            container.innerHTML = `<div class="mb-12 text-center lg:text-left"><h2 class="text-4xl font-black text-slate-900 tracking-tighter">Phase ${state.currentLevel} <span class="text-indigo-600">Case Cards</span></h2></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${data.map((item, i) => `<div class="bg-white p-10 rounded-[3.5rem] border-2 border-slate-50 hover:border-indigo-100 transition-all text-center group shadow-sm flex flex-col items-center overflow-hidden"><div class="text-5xl mb-8 group-hover:scale-110 transition-transform">${item.emoji || 'üìó'}</div><h3 class="text-3xl font-black text-slate-900 tracking-tighter mb-8 break-word-custom w-full">${item.word}</h3><div class="pt-6 border-t border-slate-50 w-full"><p class="text-2xl font-bold text-slate-800 font-kannada leading-tight break-word-custom">${item.meaning_kannada}</p><p class="text-sm text-slate-400 mt-3 font-medium leading-relaxed italic break-word-custom">${item.meaning_english}</p></div></div>`).join('')}<div class="col-span-full mt-10"><button onclick="loadQuiz()" class="w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-2xl uppercase text-xs tracking-widest active:scale-95 transition-all">Launch Assessment</button></div></div>`;
        }

        window.loadQuiz = async () => {
            const container = document.getElementById('content-container');
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const url = new URL(`content/general-english/${type}/${topic}/level${level}-test.json`, window.location.origin + getBaseDir()).href;
            try {
                const res = await fetch(url);
                const questions = await res.json();
                renderQuiz(questions);
            } catch (e) { alert("Test case missing."); }
        };

        function renderQuiz(questions) {
            const container = document.getElementById('content-container');
            container.innerHTML = `<h2 class="text-3xl font-black mb-10">Assessment Phase</h2><div id="quiz-list" class="space-y-6"></div>`;
            const list = document.getElementById('quiz-list');
            questions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = "bg-white p-10 rounded-[3.5rem] border-2 border-slate-100 shadow-sm";
                div.innerHTML = `<p class="text-lg font-bold mb-8">#${i+1} ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${q.options.map(o => `<label class="flex items-center gap-4 px-8 py-5 border-2 border-slate-50 rounded-[2rem] cursor-pointer hover:bg-slate-50 has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50 transition-all"><input type="radio" name="q${i}" value="${o}" class="accent-indigo-600 w-5 h-5"><span>${o}</span></label>`).join('')}</div>`;
                list.appendChild(div);
            });
            const btn = document.createElement('button');
            btn.className = "w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-xl uppercase mt-8";
            btn.innerText = "Synchronize Results";
            btn.onclick = () => submitTest(questions);
            list.appendChild(btn);
        }

        async function submitTest(questions) {
            let score = 0, wrong = 0, mistakesFound = [], resultHTML = "";
            questions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                const isCorrect = sel && sel.value.trim() === q.answer.trim();
                if (isCorrect) score++; else {
                    wrong++;
                    mistakesFound.push({ question: q.question, answer: q.answer, options: q.options, explanation: q.explanation, userAnswer: sel ? sel.value : 'No selection' });
                }
                const bgColor = isCorrect ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100';
                resultHTML += `<div class="${bgColor} p-8 rounded-[2.5rem] mb-6 border transition-all"><div class="flex items-center justify-between mb-4"><span class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-xs font-bold text-slate-400">#${i + 1}</span><p class="text-[10px] font-black uppercase ${isCorrect ? 'text-emerald-600' : 'text-rose-500'}">${isCorrect ? 'Correct' : 'Incorrect'}</p></div><p class="text-slate-800 font-bold mb-4">${q.question}</p><div class="grid grid-cols-2 gap-4"><div class="bg-white/60 p-4 rounded-xl"><p class="text-[8px] font-black opacity-60 uppercase mb-1">Your Choice</p><p class="text-sm font-bold">${sel ? sel.value : 'None'}</p></div><div class="bg-emerald-500/10 p-4 rounded-xl"><p class="text-[8px] font-black text-emerald-600 uppercase mb-1">Correct Answer</p><p class="text-sm font-bold text-emerald-700">${q.answer}</p></div></div><p class="mt-4 text-xs italic text-slate-500">${q.explanation || ''}</p></div>`;
            });
            const points = score * 10 + (score === questions.length ? 50 : 0);
            const coins = score - Math.floor(wrong/4);
            await saveResultToCloud(score, questions.length, points, coins, mistakesFound);
            renderResultsView(score, questions.length, points, coins, resultHTML);
        }

        function renderResultsView(score, total, pts, coins, html) {
            const container = document.getElementById('content-container');
            container.innerHTML = `<div class="view-transition"><div class="bg-white border-2 border-slate-100 p-16 rounded-[4rem] shadow-sm text-center mb-10 relative overflow-hidden"><div class="flex justify-center gap-10 mb-10"><div class="text-center"><p class="text-4xl font-black text-emerald-600">ü™ô +${score}</p><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Coins</p></div><div class="w-px h-12 bg-slate-100 self-center"></div><div class="text-center"><p class="text-4xl font-black text-indigo-600">PTS ${pts}</p><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Points</p></div></div><h2 class="text-5xl font-black text-slate-900 mb-4 tracking-tighter">Level Analysis</h2><div class="flex justify-center items-baseline gap-2 mb-12"><span class="text-[6rem] font-black text-indigo-600 leading-none">${score}</span><span class="text-3xl font-bold text-slate-300">/ ${total}</span></div><div class="flex flex-col sm:flex-row gap-6 justify-center"><button onclick="navigateTo('home')" class="px-12 py-5 bg-slate-900 text-white font-black rounded-2xl hover:bg-slate-800 transition-all uppercase tracking-widest text-[10px]">Return Dashboard</button></div></div><h3 class="text-2xl font-black text-slate-900 mb-10 px-4 uppercase tracking-[0.1em]">Mastery Review Log</h3>${html}</div>`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function saveResultToCloud(score, total, points, coins, mistakes) {
            if (!auth.currentUser) return;
            const progressId = `${state.currentType}_${state.currentTopic}_${state.currentLevel}`;
            await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'progress', progressId), { score, total, points, coins, completedAt: new Date().toISOString(), type: state.currentType, topic: state.currentTopic, level: state.currentLevel });
            for (const m of mistakes) {
                const mId = btoa(m.question).substring(0, 20);
                await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'mistakes', mId), { ...m, type: state.currentType, topic: state.currentTopic, level: state.currentLevel, masteryCount: 0 });
            }
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', state.userId), { name: state.userName, points: state.totalPoints + points, lastActive: new Date().toISOString() }, { merge: true });
        }

        // --- TRACK NAVIGATION ---
        function renderEnglishSelection() { return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center"><button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Dashboard</button><h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-12">English <span class="text-indigo-600">Track</span></h2><div class="grid grid-cols-1 md:grid-cols-2 gap-10 text-left"><div onclick="navigateTo('topics-grid', { currentType: 'grammar' })" class="premium-card group border-indigo-50"><span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-[9px] font-black rounded-full uppercase tracking-widest mb-6 inline-block border border-indigo-100">Rule Foundations</span><h3 class="text-3xl font-black mb-4 tracking-tight">English Grammar</h3><p class="text-slate-500 mb-8 leading-relaxed">Master Foundations.</p><span class="text-indigo-600 font-bold text-sm uppercase tracking-widest">Open Unit ‚ûú</span></div><div onclick="navigateTo('topics-grid', { currentType: 'vocabulary' })" class="premium-card group border-emerald-50"><span class="px-3 py-1 bg-emerald-50 text-emerald-700 text-[9px] font-black rounded-full uppercase tracking-widest mb-6 inline-block border border-emerald-100">Recall Case</span><h3 class="text-3xl font-black mb-4 tracking-tight">Vocabulary Hub</h3><p class="text-slate-500 mb-8 leading-relaxed">Recall mappings.</p><span class="text-emerald-600 font-bold text-sm uppercase tracking-widest">Open Unit ‚ûú</span></div></div></div>`; }
        function renderTopicsGrid() { const topics = topicsData[state.currentType]; return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center"><button onclick="navigateTo('english-selection')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Back</button><h2 class="text-4xl font-black text-slate-900 tracking-tighter capitalize mb-12">${state.currentType} Mastery</h2><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 text-left">${topics.map(t => `<div onclick="navigateTo('levels-grid', { currentTopic: '${t.id}', currentTopicTitle: '${t.title}' })" class="premium-card p-10 group shadow-sm"><div class="text-5xl mb-8 group-hover:scale-125 transition-all duration-500">${t.icon}</div><h3 class="text-xl font-bold text-slate-900 mb-4 tracking-tight">${t.title}</h3><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Integrated Phase</p></div>`).join('')}</div></div>`; }
        function renderLevelsGrid() { return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center"><button onclick="navigateTo('topics-grid')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Back</button><h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-16 font-bold">${state.currentTopicTitle} Phases</h2><div class="grid grid-cols-2 md:grid-cols-5 gap-6">${Array.from({length: 10}, (_, i) => i + 1).map(lv => { const progressId = `${state.currentType}_${state.currentTopic}_${lv}`; const isDone = state.progress[progressId]; return `<div onclick="handleLevelSelection(${lv}, '${progressId}')" class="p-10 border-2 ${isDone ? 'border-emerald-500 bg-emerald-50/30' : 'border-slate-100 bg-white'} rounded-[3rem] text-center hover:border-indigo-600 transition-all cursor-pointer group shadow-sm relative">${isDone ? `<span class="absolute top-4 right-4 text-emerald-600 text-[8px] font-black bg-emerald-100 px-2 py-0.5 rounded-full uppercase border border-emerald-200">DONE</span>` : ''}<span class="text-4xl font-black text-slate-900">${lv}</span></div>`; }).join('')}</div></div>`; }
        window.handleLevelSelection = (lv, progressId) => { const isDone = state.progress[progressId]; if (isDone) { const shell = document.getElementById('app-shell'); shell.innerHTML = `<div class="max-w-xl mx-auto py-32 px-6 text-center view-transition"><div class="bg-white border-2 border-emerald-100 p-12 rounded-[3.5rem] shadow-xl"><span class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center text-3xl mb-8 mx-auto">üèÜ</span><h2 class="text-3xl font-black text-slate-900 mb-2">Phase ${lv} Complete</h2><p class="text-slate-400 font-bold uppercase tracking-widest text-[10px] mb-8">Performance: ${isDone.score}/${isDone.total}</p><div class="space-y-4"><button onclick="navigateTo('content-view', { currentLevel: ${lv} })" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl uppercase tracking-widest text-xs">Review Lessons</button><button onclick="state.currentLevel = ${lv}; state.view = 'content-view'; render(); loadQuiz();" class="w-full py-5 border-2 border-slate-100 text-slate-600 font-black rounded-2xl hover:bg-slate-50 transition-all uppercase tracking-widest text-xs">Reattempt Quiz</button><button onclick="navigateTo('levels-grid')" class="w-full py-2 text-slate-300 font-bold uppercase tracking-widest text-[10px] mt-4">Close Hub</button></div></div></div>`; } else { navigateTo('content-view', { currentLevel: lv }); } };
        function renderExamsPYQ() { return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center"><button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest">‚Üê Dashboard</button><h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-12 capitalize">${state.currentCategory} Regional Hub</h2><div class="bg-white border border-slate-100 p-20 rounded-[4rem] text-center shadow-sm"><div class="text-6xl mb-6 text-slate-200">üìÇ</div><p class="text-slate-400 font-black uppercase tracking-widest text-xs italic">Archives coming soon.</p></div></div>`; }
        function renderDoubts() { return `<div class="max-w-4xl mx-auto py-24 px-6 text-center view-transition"><div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-[2.5rem] flex items-center justify-center text-4xl mx-auto mb-10 shadow-lg shadow-emerald-100">üí¨</div><h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-4 leading-tight">Private Logic Sync</h2><p class="text-slate-500 mb-16 max-w-xl mx-auto font-medium leading-relaxed italic">Submit doubt for WhatsApp Sync.</p><div class="bg-white border border-slate-100 p-10 rounded-[4rem] shadow-sm max-w-2xl mx-auto text-left relative overflow-hidden"><textarea id="query-text" placeholder="Explain rule doubt..." class="w-full h-40 bg-slate-50 border-2 border-slate-50 p-8 rounded-[2rem] font-medium mb-8 resize-none focus:bg-white transition-all"></textarea><button onclick="askDoubtOnWA()" class="w-full py-6 bg-emerald-600 text-white font-black rounded-3xl shadow-xl uppercase tracking-widest text-[11px] hover:bg-emerald-700 transition-all">Sync via WhatsApp</button></div><button onclick="navigateTo('home')" class="mt-20 py-5 px-10 bg-slate-900 text-white font-black rounded-[2rem] hover:bg-slate-800 transition-all uppercase tracking-widest text-[10px]">Return Dashboard</button></div>`; }
        function renderLogin() { const isLogin = state.authMode === 'login'; return `<div class="max-w-md mx-auto py-32 px-6 view-transition text-center"><h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-10">${isLogin ? 'Mission Login' : 'Enroll Academy'}</h2><form id="login-form" class="bg-white border border-slate-200 p-10 rounded-[3rem] shadow-sm text-left">${!isLogin ? `<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Full Name</label><input id="name-input" type="text" placeholder="Name" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-6 focus:bg-white transition-all" required>` : ''}<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Username ID</label><input id="username-input" type="text" placeholder="ID" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-6 focus:bg-white transition-all" required><label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Password</label><input id="password-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-10 focus:bg-white transition-all" required><button type="submit" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl uppercase text-xs">Authorize</button><button type="button" onclick="state.authMode = '${isLogin ? 'signup' : 'login'}'; render();" class="mt-8 w-full text-indigo-600 font-bold text-xs hover:underline">${isLogin ? "New? Create ID" : "Login Now"}</button></form></div>`; }

        window.askDoubtOnWA = function() {
            const input = document.getElementById('query-text');
            const userMsg = input.value.trim();
            const text = encodeURIComponent(`PrepEase Inquiry\nFrom: ${state.userName}\n\nDoubt: ${userMsg || "General Doubt"}`);
            window.open(`https://wa.me/918088165696?text=${text}`, '_blank');
            input.value = '';
        };

        onAuthStateChanged(auth, (user) => { if (user) loadUserData(); else { state.isAuthenticated = false; render(); } });
        document.addEventListener('DOMContentLoaded', () => { 
            render(); 
            document.addEventListener('submit', (e) => { 
                if (e.target.id === 'login-form') handleLogin(e); 
            }); 
        });

        let fqi = 0;
        setInterval(() => {
            const el = document.getElementById('floating-quote');
            if (!el) return;
            el.style.opacity = '0';
            setTimeout(() => {
                fqi = (fqi + 1) % floatingQuotes.length;
                el.innerText = floatingQuotes[fqi];
                el.style.opacity = '1';
            }, 500);
        }, 6000);
    </script>
</body>
</html>
