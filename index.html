<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrepEase | Karnataka & SSC Mastery Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { scroll-behavior: smooth; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a; 
            overflow-x: hidden; 
        }
        
        .hero-gradient {
            background: radial-gradient(circle at 100% 0%, rgba(67, 56, 202, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 0% 100%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            background-color: #ffffff;
        }

        .premium-card {
            @apply bg-white border border-slate-200 rounded-[2.5rem] p-8 transition-all duration-500 cursor-pointer;
            box-shadow: 0 4px 12px -2px rgba(15, 23, 42, 0.03);
        }

        .premium-card:hover {
            @apply -translate-y-2;
            box-shadow: 0 20px 30px -10px rgba(67, 56, 202, 0.12);
            border-color: rgba(67, 56, 202, 0.3);
        }

        /* ANKI CARD Challenge STYLES */
        .anki-card {
            perspective: 1000px;
            height: 580px;
            width: 100%;
        }
        .anki-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .anki-card.flipped .anki-card-inner {
            transform: rotateY(180deg);
        }
        .anki-front, .anki-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            @apply rounded-[3.5rem] border-2 p-6 md:p-10 flex flex-col justify-center items-center;
        }
        .anki-front { @apply border-slate-100 bg-white shadow-xl shadow-slate-100/50; }
        .anki-back { 
            @apply border-indigo-100 bg-indigo-50 shadow-2xl shadow-indigo-100/50;
            transform: rotateY(180deg);
        }

        .font-kannada { line-height: 1.6; }
        
        @keyframes box-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .logo-box { animation: box-pulse 4s ease-in-out infinite; }

        .view-transition { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* WORD WRAP FIX - Vital for card content */
        .break-word-custom {
            overflow-wrap: anywhere;
            word-break: break-word;
            hyphens: auto;
        }
    </style>
</head>
<body>

    <!-- TOP NAVIGATION BAR - Minimalist -->
    <nav class="fixed top-0 w-full z-50 bg-white/80 backdrop-blur-xl border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 group cursor-pointer" onclick="navigateTo('home')">
                <div class="relative flex items-center justify-center logo-box">
                    <svg width="36" height="36" viewBox="0 0 40 40" fill="none"><rect width="40" height="40" rx="10" fill="#4338ca"/><path d="M15 28V12H21.5C24.5376 12 27 14.4624 27 17.5C27 20.5376 24.5376 23 21.5 23H15" stroke="white" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <span class="text-xl font-black tracking-tighter uppercase font-bold">PrepEase</span>
            </div>
            
            <div id="auth-header-btn">
                <!-- Login/Logout dynamically injected -->
            </div>
        </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main id="app-shell" class="pt-20 min-h-screen">
        <!-- Content loads here -->
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyAh6pjj_eOmw2I6FMM63bDmwj5eIlbvZAI",
            authDomain: "prepease-app.firebaseapp.com",
            projectId: "prepease-app",
            storageBucket: "prepease-app.firebasestorage.app",
            messagingSenderId: "200948432412",
            appId: "1:200948432412:web:de0582b6437305c822a9d9",
            measurementId: "G-5673GJ545C"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'prepease-app';

        // --- DATA & STATE ---
        const quotes = [
            "Consistency is the key to Selection. üéØ",
            "Mastering English is half the battle won. üá¨üáß",
            "Focus on the mission, not the competition. ‚öîÔ∏è",
            "Your future self will thank you for this practice session. üèõÔ∏è",
            "Discipline is the bridge between goals and accomplishment. üáÆüá≥"
        ];

        const state = {
            view: 'home',
            isAuthenticated: false,
            userName: '',
            userId: null,
            progress: {},
            mistakes: [],
            totalPoints: 0,
            totalCoins: 0,
            authMode: 'login',
            currentAnkiIndex: 0,
            isAnkiFlipped: false
        };

        const topicsData = {
            grammar: [
                { id: 'nouns', title: 'Nouns & Case', icon: 'üî°' },
                { id: 'tenses', title: 'Tense Mastery', icon: '‚è≥' },
                { id: 'articles', title: 'Articles', icon: 'üÖ∞Ô∏è' }
            ],
            vocabulary: [
                { id: 'synonyms', title: 'Synonyms', icon: 'üìñ' },
                { id: 'antonyms', title: 'Antonyms', icon: 'üåì' },
                { id: 'idioms', title: 'Idioms & Phrases', icon: 'üé≠' }
            ]
        };

        // --- NAVIGATION ---
        window.navigateTo = (view, params = {}) => {
            const protectedViews = ['english-selection', 'topics-grid', 'levels-grid', 'content-view', 'mistakes-book', 'doubts', 'exams-pyq'];
            if (protectedViews.includes(view) && !state.isAuthenticated) {
                state.view = 'login';
            } else {
                state.view = view;
            }
            Object.assign(state, params);
            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function getBaseDir() {
            const path = window.location.pathname;
            return path.substring(0, path.lastIndexOf('/') + 1) || '/';
        }

        // --- FIREBASE DATA FLOW ---
        async function loadUserData() {
            if (!auth.currentUser) return;
            state.userId = auth.currentUser.uid;

            const profileRef = doc(db, 'artifacts', appId, 'users', state.userId, 'profile', 'info');
            const profileSnap = await getDoc(profileRef);
            if (profileSnap.exists()) {
                state.userName = profileSnap.data().name;
                state.isAuthenticated = true;
            }

            onSnapshot(collection(db, 'artifacts', appId, 'users', state.userId, 'progress'), (snap) => {
                state.progress = {}; state.totalPoints = 0; state.totalCoins = 0;
                snap.forEach(doc => {
                    const d = doc.data();
                    state.progress[doc.id] = d;
                    state.totalPoints += (d.points || 0);
                    state.totalCoins += (d.coins || 0);
                });
                if (state.view === 'home') render();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'users', state.userId, 'mistakes'), (snap) => {
                state.mistakes = [];
                snap.forEach(doc => state.mistakes.push({ id: doc.id, ...doc.data() }));
                state.mistakes = state.mistakes.sort(() => Math.random() - 0.5);
                if (state.view === 'home' || state.view === 'mistakes-book') render();
            });
        }

        // --- RENDER VIEWS ---
        function render() {
            const shell = document.getElementById('app-shell');
            const authBtn = document.getElementById('auth-header-btn');

            if (state.isAuthenticated) {
                authBtn.innerHTML = `<button onclick="handleLogout()" class="text-[10px] font-black uppercase tracking-widest text-rose-500 px-4 py-2 hover:bg-rose-50 rounded-xl transition-all">Sign Out</button>`;
            } else {
                authBtn.innerHTML = `<button onclick="navigateTo('login')" class="text-[10px] font-black uppercase tracking-widest text-indigo-600 px-4 py-2 hover:bg-indigo-50 rounded-xl transition-all">Login</button>`;
            }

            if (!state.isAuthenticated && state.view !== 'login') {
                state.view = 'login';
            }

            switch(state.view) {
                case 'home': shell.innerHTML = renderHome(); break;
                case 'login': shell.innerHTML = renderLogin(); break;
                case 'mistakes-book': shell.innerHTML = renderMistakesBook(); break;
                case 'doubts': shell.innerHTML = renderDoubts(); break;
                case 'english-selection': shell.innerHTML = renderEnglishSelection(); break;
                case 'topics-grid': shell.innerHTML = renderTopicsGrid(); break;
                case 'levels-grid': shell.innerHTML = renderLevelsGrid(); break;
                case 'exams-pyq': shell.innerHTML = renderExamsPYQ(); break;
                case 'content-view': shell.innerHTML = `<div id="content-container" class="max-w-6xl mx-auto px-6 py-20"></div>`; loadContent(); break;
            }
        }

        function renderHome() {
            const rank = (p) => p < 500 ? 'üå± Junior Aspirant' : p < 2000 ? '‚öîÔ∏è Warrior' : 'üèõÔ∏è Officer';
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            return `
                <div class="hero-gradient p-10 view-transition">
                    <div class="max-w-7xl mx-auto">
                        <!-- Personalized Bold Greeting -->
                        <div class="mb-12">
                            <h2 class="text-6xl font-black text-slate-900 tracking-tighter mb-4 leading-tight font-bold">Hello, <span class="text-indigo-600">${state.userName || 'Aspirant'}!</span></h2>
                            <p class="text-lg text-slate-400 font-medium italic">"${randomQuote}"</p>
                        </div>

                        <!-- Visibility of Points Summary -->
                        <div class="mb-12">
                            <div class="bg-indigo-600 p-12 rounded-[3.5rem] text-white shadow-2xl shadow-indigo-200 flex flex-col md:flex-row justify-between items-center gap-8">
                                <div class="text-center md:text-left">
                                    <p class="text-[10px] font-black uppercase tracking-widest opacity-60 mb-2">Total Progress</p>
                                    <p class="text-7xl font-black leading-none">${state.totalPoints}</p>
                                    <p class="text-sm font-bold opacity-80 mt-2 uppercase tracking-tighter">Mastery Points</p>
                                </div>
                                <div class="flex gap-6">
                                    <div class="bg-white/10 p-6 rounded-3xl text-center border border-white/5">
                                        <p class="text-2xl font-black">ü™ô ${state.totalCoins}</p>
                                        <p class="text-[9px] font-black uppercase opacity-60 mt-1 font-bold">Coins</p>
                                    </div>
                                    <div class="bg-white/10 p-6 rounded-3xl text-center border border-white/5">
                                        <p class="text-2xl font-black">${rank(state.totalPoints).split(' ')[1]}</p>
                                        <p class="text-[9px] font-black uppercase opacity-60 mt-1 font-bold">Rank</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Learning Paths Grid -->
                        <div class="mb-16">
                            <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-8 font-bold">Curriculum Roadmap</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div onclick="navigateTo('english-selection')" class="premium-card group">
                                    <div class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-all">üá¨üáß</div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">General English</h3>
                                    <p class="text-slate-500 text-xs leading-relaxed">Levels 1-10 complete curriculum for selection exams.</p>
                                </div>
                                <div onclick="navigateTo('exams-pyq', { currentCategory: 'karnataka' })" class="premium-card group border-emerald-50">
                                    <div class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-emerald-600 group-hover:text-white transition-all">üèõÔ∏è</div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">KPSC Hub</h3>
                                    <p class="text-slate-500 text-xs leading-relaxed">FDA, SDA archives and state selection blueprints.</p>
                                </div>
                                <div onclick="navigateTo('exams-pyq', { currentCategory: 'ssc' })" class="premium-card group border-amber-50">
                                    <div class="w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-amber-600 group-hover:text-white transition-all">‚öîÔ∏è</div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2 font-bold">SSC Central</h3>
                                    <p class="text-slate-500 text-xs leading-relaxed">CGL, CHSL focus and central selection tracks.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Revision & Support Section (End of Page) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                            <div onclick="navigateTo('mistakes-book')" class="bg-white border-2 border-rose-100 p-10 rounded-[3.5rem] shadow-sm hover:shadow-xl transition-all cursor-pointer group flex items-center justify-between">
                                <div>
                                    <p class="text-[10px] font-black uppercase tracking-widest text-rose-400 font-bold mb-1">Retention Lab</p>
                                    <h3 class="text-2xl font-bold text-slate-900">Mistakes Book</h3>
                                    <p class="text-slate-500 text-xs mt-2">Active revision for ${state.mistakes.length} recorded errors.</p>
                                </div>
                                <div class="w-16 h-16 bg-rose-50 text-rose-600 rounded-3xl flex items-center justify-center text-3xl group-hover:bg-rose-600 group-hover:text-white transition-all">üìì</div>
                            </div>
                            
                            <div onclick="navigateTo('doubts')" class="bg-white border-2 border-emerald-100 p-10 rounded-[3.5rem] shadow-sm hover:shadow-xl transition-all cursor-pointer group flex items-center justify-between">
                                <div>
                                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-500 font-bold mb-1">Personal Support</p>
                                    <h3 class="text-2xl font-bold text-slate-900">Support Desk</h3>
                                    <p class="text-slate-500 text-xs mt-2">Private logic doubt clearing via WhatsApp.</p>
                                </div>
                                <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-3xl flex items-center justify-center text-3xl group-hover:bg-emerald-600 group-hover:text-white transition-all">üí¨</div>
                            </div>
                        </div>

                        <!-- Minimal Footer -->
                        <div class="pt-10 border-t border-slate-100 flex flex-col md:flex-row justify-between items-center gap-6">
                            <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest font-bold">¬© 2026 PrepEase Mastery –ê–∫–∞–¥–µ–º–∏—è</p>
                            <div class="flex gap-6">
                                <a href="https://t.me/prepeaseengl" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                                    <span class="p-1 bg-indigo-50 rounded-lg">üì¢</span> Telegram Channel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- ANKI MISTAKES LOGIC (Requirement: Challenge with 4 Options) ---
        function renderMistakesBook() {
            if (state.mistakes.length === 0) {
                return `<div class="max-w-xl mx-auto py-40 text-center view-transition">
                    <div class="text-6xl mb-6 text-indigo-600">üíé</div>
                    <h3 class="text-2xl font-black text-slate-900 mb-2 uppercase tracking-tight font-bold">Target Mastery: 100%</h3>
                    <p class="text-slate-400 font-bold uppercase text-xs tracking-widest mb-10">All active mistakes have been resolved.</p>
                    <button onclick="navigateTo('home')" class="px-12 py-5 bg-indigo-600 text-white font-black rounded-3xl shadow-xl uppercase text-xs">Return Dashboard</button>
                </div>`;
            }

            const current = state.mistakes[state.currentAnkiIndex];
            const flippedClass = state.isAnkiFlipped ? 'flipped' : '';
            const options = current.options || ['Loading...', '...', '...', '...'];

            return `
                <div class="max-w-3xl mx-auto py-20 px-6 view-transition">
                    <div class="flex justify-between items-center mb-10">
                        <h2 class="text-xl font-black text-slate-900 uppercase tracking-widest font-bold">Error Anki challenge</h2>
                        <span class="text-[10px] font-black bg-slate-900 text-white px-4 py-1.5 rounded-full font-bold">${state.currentAnkiIndex + 1} / ${state.mistakes.length}</span>
                    </div>

                    <div class="anki-card ${flippedClass}">
                        <div class="anki-card-inner">
                            <div class="anki-front">
                                <span class="px-4 py-1.5 bg-rose-50 text-rose-600 rounded-full text-[9px] font-black uppercase mb-8 border border-rose-100">Selection Critical Recall</span>
                                <h3 class="text-2xl font-bold text-slate-900 leading-relaxed mb-10 italic break-word-custom font-bold">"${current.question}"</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full">
                                    ${options.map(o => `
                                        <button onclick="resolveAnki('${o.trim()}', '${current.answer.trim()}')" 
                                                class="w-full py-4 px-6 border-2 border-slate-50 bg-slate-50/50 rounded-[2rem] text-sm font-bold text-slate-600 hover:border-indigo-600 hover:bg-white transition-all text-left break-word-custom">
                                            ${o}
                                        </button>
                                    `).join('')}
                                </div>
                                <p class="mt-8 text-slate-300 text-[10px] font-black uppercase tracking-widest font-bold">Identify correct logic to flip card</p>
                            </div>
                            <div class="anki-back">
                                <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-6">Mastery Logic Review</p>
                                <div class="bg-white/60 p-8 rounded-[2.5rem] mb-6 w-full border border-indigo-100">
                                    <p class="text-[10px] font-black text-emerald-600 uppercase mb-2">Mastery Answer</p>
                                    <p class="text-2xl font-bold text-slate-900 font-kannada leading-tight break-word-custom">${current.answer}</p>
                                </div>
                                <p class="text-sm text-indigo-900 font-medium leading-relaxed italic break-word-custom">"${current.explanation || 'Review the unit case cards for mapping context.'}"</p>
                                
                                <button onclick="nextAnki()" class="mt-10 px-12 py-5 bg-indigo-600 text-white font-black rounded-3xl text-[10px] uppercase shadow-lg shadow-indigo-200">Next Case Entry ‚ûú</button>
                                <p class="mt-6 text-[9px] font-black text-slate-400 uppercase tracking-widest">Mastery Progress: ${current.masteryCount || 0}/5</p>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        window.resolveAnki = async (selected, correct) => {
            const current = state.mistakes[state.currentAnkiIndex];
            const mRef = doc(db, 'artifacts', appId, 'users', state.userId, 'mistakes', current.id);
            const isCorrect = selected === correct;
            
            if (isCorrect) {
                const count = (current.masteryCount || 0) + 1;
                if (count >= 5) await deleteDoc(mRef);
                else await updateDoc(mRef, { masteryCount: count });
            } else {
                await updateDoc(mRef, { masteryCount: 0 });
            }
            state.isAnkiFlipped = true;
            render();
        };

        window.nextAnki = () => {
            state.isAnkiFlipped = false;
            state.currentAnkiIndex = (state.currentAnkiIndex + 1) % state.mistakes.length;
            render();
        };

        // --- SUPPORT HUB ---
        function renderDoubts() {
            return `
                <div class="max-w-4xl mx-auto py-24 px-6 text-center view-transition">
                    <div class="w-24 h-24 bg-emerald-50 text-emerald-600 rounded-[2.5rem] flex items-center justify-center text-4xl mx-auto mb-10 shadow-lg shadow-emerald-100 font-bold">üí¨</div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-4 leading-tight font-bold">Private Logic Sync</h2>
                    <p class="text-slate-500 mb-16 max-w-xl mx-auto font-medium leading-relaxed italic">Detail your doubt regarding a rule or word mapping. Clicking submit opens your private sync with a mentor.</p>
                    
                    <div class="bg-white border border-slate-100 p-10 rounded-[4rem] shadow-sm max-w-2xl mx-auto text-left relative overflow-hidden">
                        <textarea id="query-text" placeholder="Explain the specific grammar rule or vocabulary doubt..." class="w-full h-40 bg-slate-50 border-2 border-slate-50 p-8 rounded-[2rem] font-medium mb-8 resize-none focus:bg-white transition-all"></textarea>
                        <button onclick="askDoubtOnWA()" class="w-full py-6 bg-emerald-600 text-white font-black rounded-3xl shadow-xl uppercase tracking-widest text-[11px] hover:bg-emerald-700 transition-all font-bold">Open WhatsApp Sync Hub</button>
                    </div>

                    <button onclick="navigateTo('home')" class="mt-20 py-5 px-10 bg-slate-900 text-white font-black rounded-[2rem] hover:bg-slate-800 transition-all uppercase tracking-widest text-[10px] font-bold">Return Hub</button>
                </div>`;
        }

        window.askDoubtOnWA = function() {
            const input = document.getElementById('query-text');
            const userMsg = input.value.trim();
            const text = encodeURIComponent(`Mastery Sync Portal\nAspirant: ${state.userName}\n\nDoubt: ${userMsg || "General Logic doubt regarding curriculum studies."}`);
            window.open(`https://wa.me/918088165696?text=${text}`, '_blank');
            input.value = '';
        };

        // --- AUTH LOGIC ---
        function renderLogin() {
            const isLogin = state.authMode === 'login';
            return `<div class="max-w-md mx-auto py-32 px-6 view-transition">
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-2 text-center leading-tight font-bold">${isLogin ? 'Mission Login' : 'Enroll Academy'}</h2>
                <form id="login-form" class="bg-white border border-slate-200 p-10 rounded-[3rem] shadow-sm">
                    ${!isLogin ? `<label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-bold">Full Name</label><input id="name-input" type="text" placeholder="Your Name" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-6" required>` : ''}
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-bold">Username ID</label><input id="username-input" type="text" placeholder="aspirant_id" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-6" required>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 font-bold">Password</label><input id="password-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-5 py-4 bg-slate-50 border-2 border-slate-50 rounded-2xl font-bold mb-10" required>
                    <button type="submit" class="w-full py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl uppercase text-xs font-bold active:scale-95 transition-all">Authorize</button>
                    <button type="button" onclick="state.authMode = '${isLogin ? 'signup' : 'login'}'; render();" class="mt-8 w-full text-indigo-600 font-bold text-xs hover:underline">${isLogin ? "New Aspirant? Create ID" : "Login Now"}</button>
                </form>
            </div>`;
        }

        async function handleLogin(e) {
            e.preventDefault();
            const userIn = document.getElementById('username-input').value;
            const passIn = document.getElementById('password-input').value;
            const isSignUp = state.authMode === 'signup';
            const email = `${userIn.toLowerCase()}@prepease.internal`;
            try {
                if (isSignUp) {
                    const name = document.getElementById('name-input').value;
                    const res = await createUserWithEmailAndPassword(auth, email, passIn);
                    await setDoc(doc(db, 'artifacts', appId, 'users', res.user.uid, 'profile', 'info'), { name, joinedAt: new Date().toISOString() });
                } else { await signInWithEmailAndPassword(auth, email, passIn); }
                navigateTo('home');
            } catch (e) { alert("Authorization Denied: Check ID/Password."); }
        }

        window.handleLogout = async () => { await signOut(auth); state.isAuthenticated = false; navigateTo('home'); };

        // --- TRACKS ---
        function renderEnglishSelection() {
            return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                <button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest font-bold">‚Üê Dashboard</button>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-12 font-bold">English <span class="text-indigo-600">Track</span></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 text-left">
                    <div onclick="navigateTo('topics-grid', { currentType: 'grammar' })" class="premium-card group border-indigo-50">
                        <span class="px-3 py-1 bg-indigo-50 text-indigo-700 text-[9px] font-black rounded-full uppercase tracking-widest mb-6 inline-block border border-indigo-100 font-bold">Rule Foundations</span>
                        <h3 class="text-3xl font-black mb-4 tracking-tight font-bold">English Grammar</h3>
                        <p class="text-slate-500 mb-8 leading-relaxed">Systematic mastery of foundations for SSC & KPSC recruitment.</p>
                        <span class="text-indigo-600 font-bold text-sm uppercase tracking-widest">Master Units ‚ûú</span>
                    </div>
                    <div onclick="navigateTo('topics-grid', { currentType: 'vocabulary' })" class="premium-card group border-emerald-50">
                        <span class="px-3 py-1 bg-emerald-50 text-emerald-700 text-[9px] font-black rounded-full uppercase tracking-widest mb-6 inline-block border border-emerald-100 font-bold">Recall Case</span>
                        <h3 class="text-3xl font-black mb-4 tracking-tight font-bold">Vocabulary Hub</h3>
                        <p class="text-slate-500 mb-8 leading-relaxed">mappings for high-frequency synonyms and idioms.</p>
                        <span class="text-emerald-600 font-bold text-sm uppercase tracking-widest">Master Units ‚ûú</span>
                    </div>
                </div>
            </div>`;
        }

        function renderTopicsGrid() {
            const topics = topicsData[state.currentType];
            return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                <button onclick="navigateTo('english-selection')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest font-bold">‚Üê Category</button>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter capitalize mb-12 font-bold">${state.currentType} Mastery</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
                    ${topics.map(t => `
                        <div onclick="navigateTo('levels-grid', { currentTopic: '${t.id}', currentTopicTitle: '${t.title}' })" class="premium-card p-10 group shadow-sm">
                            <div class="text-5xl mb-8 group-hover:scale-125 transition-all duration-500 font-bold">${t.icon}</div>
                            <h3 class="text-xl font-bold text-slate-900 mb-4 tracking-tight font-bold">${t.title}</h3>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest font-bold">Levels 1-10 Integrated</p>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        function renderLevelsGrid() {
            return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                <button onclick="navigateTo('topics-grid')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest font-bold">‚Üê Topics</button>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-16 font-bold">${state.currentTopicTitle} Phases</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                    ${Array.from({length: 10}, (_, i) => i + 1).map(lv => {
                        const progressId = `${state.currentType}_${state.currentTopic}_${lv}`;
                        const isDone = state.progress[progressId];
                        return `<div onclick="navigateTo('content-view', { currentLevel: ${lv} })" 
                            class="p-10 border-2 ${isDone ? 'border-emerald-500 bg-emerald-50/30' : 'border-slate-100 bg-white'} rounded-[3rem] text-center hover:border-indigo-600 transition-all cursor-pointer group shadow-sm relative">
                            ${isDone ? `<span class="absolute top-4 right-4 text-emerald-600 text-[8px] font-black bg-emerald-100 px-2 py-0.5 rounded-full uppercase border border-emerald-200 font-bold">DONE</span>` : ''}
                            <span class="text-4xl font-black text-slate-900 font-bold font-bold">${lv}</span>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderExamsPYQ() {
            return `<div class="max-w-7xl mx-auto px-6 py-20 view-transition text-center">
                <button onclick="navigateTo('home')" class="text-slate-400 font-bold mb-8 flex items-center justify-center gap-2 hover:text-indigo-600 transition-colors mx-auto uppercase text-xs tracking-widest font-bold">‚Üê Dashboard</button>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-12 capitalize font-bold">${state.currentCategory} Regional Hub</h2>
                <div class="bg-white border border-slate-100 p-20 rounded-[4rem] text-center shadow-sm">
                    <div class="text-6xl mb-6 text-slate-200 font-bold font-bold">üìÇ</div>
                    <p class="text-slate-400 font-black uppercase tracking-widest text-xs italic font-bold">Official Archives coming soon in Q2 2026.</p>
                </div>
            </div>`;
        }

        window.loadContent = async () => {
            const container = document.getElementById('content-container');
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const url = new URL(`content/general-english/${type}/${topic}/level-${level}.json`, window.location.origin + getBaseDir()).href;
            container.innerHTML = `<div class="py-20 text-center animate-pulse text-slate-400 font-black uppercase text-xs font-bold font-bold font-bold">Synchronizing Mastery File...</div>`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                renderCards(data);
            } catch (e) {
                container.innerHTML = `<div class="text-center p-20 bg-white rounded-[3rem] border border-slate-100"><div class="text-5xl mb-6 text-slate-200 font-bold font-bold">üìÅ</div><h3 class="font-bold text-xl mb-4">Phase Offline</h3><code class="text-[10px] bg-slate-50 p-2 rounded block break-all text-indigo-600 mb-6 font-bold font-bold font-bold font-bold">${url}</code><button onclick="navigateTo('levels-grid')" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-2xl uppercase text-[10px]">Back to grid</button></div>`;
            }
        };

        function renderCards(data) {
            const container = document.getElementById('content-container');
            container.innerHTML = `
                <div class="mb-12 text-center lg:text-left">
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter font-bold">Phase ${state.currentLevel} <span class="text-indigo-600">Case Cards</span></h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${data.map((item, i) => `
                        <div class="bg-white p-10 rounded-[3.5rem] border-2 border-slate-50 hover:border-indigo-100 transition-all text-center group shadow-sm flex flex-col items-center overflow-hidden">
                            <div class="text-5xl mb-8 group-hover:scale-110 transition-transform font-bold font-bold">${item.emoji || 'üìó'}</div>
                            <h3 class="text-3xl font-black text-slate-900 tracking-tighter mb-8 break-word-custom w-full font-bold">${item.word}</h3>
                            <div class="pt-6 border-t border-slate-50 w-full font-bold">
                                <p class="text-2xl font-bold text-slate-800 font-kannada leading-tight break-word-custom">${item.meaning_kannada}</p>
                                <p class="text-sm text-slate-400 mt-3 font-medium leading-relaxed italic break-word-custom font-bold font-bold font-bold font-bold font-bold">${item.meaning_english}</p>
                            </div>
                        </div>
                    `).join('')}
                    <div class="col-span-full mt-10"><button onclick="loadQuiz()" class="w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-2xl uppercase text-xs tracking-widest active:scale-95 transition-all font-bold">Launch Level Assessment</button></div>
                </div>`;
        }

        window.loadQuiz = async () => {
            const container = document.getElementById('content-container');
            const { currentType: type, currentTopic: topic, currentLevel: level } = state;
            const url = new URL(`content/general-english/${type}/${topic}/level${level}-test.json`, window.location.origin + getBaseDir()).href;
            try {
                const res = await fetch(url);
                const questions = await res.json();
                renderQuiz(questions);
            } catch (e) { alert("Test case missing."); }
        };

        function renderQuiz(questions) {
            const container = document.getElementById('content-container');
            container.innerHTML = `<h2 class="text-3xl font-black mb-10 font-bold">Intelligence Analysis Phase</h2><div id="quiz-list" class="space-y-6"></div>`;
            const list = document.getElementById('quiz-list');
            questions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = "bg-white p-10 rounded-[3.5rem] border-2 border-slate-100 shadow-sm";
                div.innerHTML = `<p class="text-lg font-bold mb-8">#${i+1} ${q.question}</p><div class="grid grid-cols-1 md:grid-cols-2 gap-3 font-bold font-bold">${q.options.map(o => `<label class="flex items-center gap-4 px-8 py-5 border-2 border-slate-50 rounded-[2rem] cursor-pointer hover:bg-slate-50 has-[:checked]:border-indigo-600 has-[:checked]:bg-indigo-50 transition-all font-bold"><input type="radio" name="q${i}" value="${o}" class="accent-indigo-600 w-5 h-5"><span>${o}</span></label>`).join('')}</div>`;
                list.appendChild(div);
            });
            const btn = document.createElement('button');
            btn.className = "w-full py-8 bg-indigo-600 text-white font-black rounded-[3rem] shadow-xl uppercase mt-8 font-bold";
            btn.innerText = "Synchronize Results";
            btn.onclick = () => submitTest(questions);
            list.appendChild(btn);
        }

        async function submitTest(questions) {
            let score = 0, wrong = 0, mistakes = [];
            questions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                if (sel && sel.value.trim() === q.answer.trim()) score++;
                else { 
                    wrong++; 
                    mistakes.push({ 
                        question: q.question, 
                        answer: q.answer, 
                        options: q.options, 
                        explanation: q.explanation, 
                        userAnswer: sel ? sel.value : 'No selection' 
                    });
                }
            });
            const points = score * 10, coins = score - Math.floor(wrong/4);
            await saveResultToCloud(score, questions.length, points, coins, mistakes);
            navigateTo('home');
        }

        async function saveResultToCloud(score, total, points, coins, mistakes) {
            if (!auth.currentUser) return;
            const progressId = `${state.currentType}_${state.currentTopic}_${state.currentLevel}`;
            await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'progress', progressId), { score, total, points, coins, completedAt: new Date().toISOString(), type: state.currentType, topic: state.currentTopic, level: state.currentLevel });
            for (const m of mistakes) {
                const mId = btoa(m.question).substring(0, 20);
                await setDoc(doc(db, 'artifacts', appId, 'users', state.userId, 'mistakes', mId), { ...m, type: state.currentType, topic: state.currentTopic, level: state.currentLevel, masteryCount: 0 });
            }
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', state.userId), { name: state.userName, points: state.totalPoints + points, lastActive: new Date().toISOString() }, { merge: true });
        }

        onAuthStateChanged(auth, (user) => { if (user) loadUserData(); else { state.isAuthenticated = false; render(); } });
        document.addEventListener('DOMContentLoaded', () => { render(); document.addEventListener('submit', (e) => { if (e.target.id === 'login-form') handleLogin(e); }); });
        let qi = 0; setInterval(() => { const el = document.getElementById('moto-text'); if (!el) return; qi = (qi + 1) % quotes.length; el.innerText = quotes[qi]; }, 5000);
    </script>
</body>
</html>
